{% extends "layout.html" %}

{% block title %}Dashboard - Dataset State Historian{% endblock %}

{% block extra_css %}
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <div class="dashboard-header">
        <h1 class="dashboard-title">Dataset State Historian</h1>
        <p class="dashboard-subtitle">Comprehensive monitoring and analysis of government datasets</p>
        
        <!-- Search Bar -->
        <div class="dashboard-search">
            <div class="search-container">
                <input type="text" class="search-input" id="dashboard-search" placeholder="Search datasets, agencies, tags..." onkeyup="handleDashboardSearch(event)">
                <button class="search-button" onclick="performDashboardSearch()">Search</button>
            </div>
            <div class="search-filters">
                <select class="filter-select" id="content-type-filter">
                    <option value="">All Content Types</option>
                    <option value="csv">CSV</option>
                    <option value="json">JSON</option>
                    <option value="xml">XML</option>
                    <option value="xlsx">Excel</option>
                    <option value="zip">ZIP</option>
                </select>
                <select class="filter-select" id="status-filter">
                    <option value="">All Status</option>
                    <option value="available">Available</option>
                    <option value="unavailable">Unavailable</option>
                    <option value="unknown">Unknown</option>
                </select>
                <select class="filter-select" id="sort-filter">
                    <option value="relevance">Relevance</option>
                    <option value="date">Date</option>
                    <option value="name">Name</option>
                    <option value="agency">Agency</option>
                </select>
            </div>
        </div>
        
        <!-- Search Results -->
        <div class="search-results" id="search-results">
            <!-- Results will be populated here -->
        </div>
        
        <div class="related-reading">
            Related reading: <a href="https://www.noemamag.com/the-critical-importance-of-economic-statistics/" target="_blank" rel="noopener noreferrer">The Urgent Need for Revolutionizing Economic Statistics</a>
        </div>
    </div>

    <!-- Stats Grid -->
    <div class="stats-grid" id="stats-grid">
        <div class="stat-card">
            <div class="stat-value" id="total-datasets">-</div>
            <div class="stat-label">Total Datasets</div>
            <div class="stat-change" id="datasets-change">Loading...</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="active-datasets">-</div>
            <div class="stat-label">Active Datasets</div>
            <div class="stat-change" id="active-change">Loading...</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="vanished-datasets">-</div>
            <div class="stat-label">Vanished Datasets</div>
            <div class="stat-change" id="vanished-change">Loading...</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="total-snapshots">-</div>
            <div class="stat-label">Total Snapshots</div>
            <div class="stat-change" id="snapshots-change">Loading...</div>
        </div>
    </div>

    <!-- Charts Grid -->
    <div class="charts-grid">
        <div class="chart-card">
            <h3 class="chart-title">Dataset Status Over Time</h3>
            <div class="chart-container" id="status-chart">
                <div class="loading">Loading chart...</div>
            </div>
        </div>
        <div class="chart-card">
            <h3 class="chart-title">Agency Distribution</h3>
            <div class="chart-container" id="agency-chart">
                <div class="loading">Loading chart...</div>
            </div>
        </div>
    </div>

    <!-- Additional Charts Grid -->
    <div class="charts-grid">
        <div class="chart-card">
            <h3 class="chart-title">Data Format Distribution</h3>
            <div class="chart-container" id="format-chart">
                <div class="loading">Loading chart...</div>
            </div>
        </div>
        <div class="chart-card">
            <h3 class="chart-title">Data Quality Trends</h3>
            <div class="chart-container" id="quality-chart">
                <div class="loading">Loading chart...</div>
            </div>
        </div>
    </div>

    <!-- Recent Activity -->
    <div class="recent-activity">
        <div class="activity-header">
            <h3 class="activity-title">Recent Activity</h3>
        </div>
        <div class="activity-list" id="activity-list">
            <div class="loading">Loading recent activity...</div>
        </div>
    </div>

    <!-- Core Features Section -->
    <div class="core-features-section">
        <div class="section-header">
            <h3 class="section-title">Core Features</h3>
            <p class="section-subtitle">Advanced dataset analysis and monitoring tools</p>
        </div>
        <div class="features-grid">
            <div class="feature-card" onclick="window.location.href='/field-diff-panel'">
                <div class="feature-icon">DIFF</div>
                <h4 class="feature-title">Field Diff Panel</h4>
                <p class="feature-description">Track detailed changes to individual dataset fields over time</p>
            </div>
            <div class="feature-card" onclick="window.location.href='/content-drift-charts'">
                <div class="feature-icon">CHART</div>
                <h4 class="feature-title">Content Drift Analysis</h4>
                <p class="feature-description">Visualize content similarity, row counts, and schema evolution</p>
            </div>
            <div class="feature-card" onclick="window.location.href='/change-log-view'">
                <div class="feature-icon">LIST</div>
                <h4 class="feature-title">Change Log</h4>
                <p class="feature-description">Chronological record of all dataset changes and events</p>
            </div>
            <div class="feature-card" onclick="window.location.href='/postmortem-reports'">
                <div class="feature-icon">REPORT</div>
                <h4 class="feature-title">Post-mortem Reports</h4>
                <p class="feature-description">Analysis of vanished datasets and suspected causes</p>
            </div>
        </div>
    </div>

    <!-- Dataset Table -->
    <div class="dataset-table-section">
        <div class="section-header">
            <h3 class="section-title">Recent Datasets</h3>
            <a href="/search" class="view-all-link">VIEW ALL</a>
        </div>
        <div class="dataset-table-container">
            <table class="dataset-table" id="dataset-table">
                <thead>
                    <tr>
                        <th>Dataset</th>
                        <th>Agency</th>
                        <th>Rows</th>
                        <th>Columns</th>
                        <th>Status</th>
                        <th>Last Updated</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td colspan="7" class="loading">Loading datasets...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

</div>
{% endblock %}

{% block extra_js %}
<script>
// Load dashboard data
function loadDashboardData() {
    // Load stats
    fetch('/api/stats')
        .then(response => response.json())
        .then(data => {
            document.getElementById('total-datasets').textContent = data.total_datasets || '0';
            document.getElementById('active-datasets').textContent = data.availability_stats?.available || '0';
            document.getElementById('vanished-datasets').textContent = data.vanished_datasets || '0';
            document.getElementById('total-snapshots').textContent = data.total_snapshots || '0';
            
            // Update change indicators
            updateChangeIndicator('datasets-change', data.datasets_change);
            updateChangeIndicator('active-change', data.active_change);
            updateChangeIndicator('vanished-change', data.vanished_change);
            updateChangeIndicator('snapshots-change', data.snapshots_change);
        })
        .catch(error => {
            console.error('Error loading stats:', error);
            showError('Error loading statistics');
        });
    
    // Load recent activity
    loadRecentActivity();
    
    // Load dataset table
    loadDatasetTable();
    
    // Load charts
    loadCharts();
}

// Update change indicator
function updateChangeIndicator(elementId, change) {
    const element = document.getElementById(elementId);
    if (change && change !== 0) {
        element.textContent = `${change > 0 ? '+' : ''}${change} from last week`;
        element.className = `stat-change ${change > 0 ? 'positive' : 'negative'}`;
    } else {
        element.textContent = 'No change';
        element.className = 'stat-change';
    }
}

// Load recent activity
function loadRecentActivity() {
    fetch('/api/wayback/changes/recent')
        .then(response => response.json())
        .then(data => {
            const container = document.getElementById('activity-list');
            
            if (data.changes && data.changes.length > 0) {
                container.innerHTML = data.changes.slice(0, 10).map(change => `
                    <div class="activity-item">
                        <div class="activity-icon">ANALYTICS</div>
                        <div class="activity-content">
                            <div class="activity-title-text">
                                <a href="/dataset/${change.dataset_id}" style="color: inherit; text-decoration: none;">${escapeHtml(change.title)}</a>
                            </div>
                            <div class="activity-description">${escapeHtml(change.agency)} â€¢ ${change.status}</div>
                        </div>
                        <div class="activity-time">${new Date(change.date).toLocaleDateString()}</div>
                    </div>
                `).join('');
            } else {
                container.innerHTML = '<div class="loading">No recent activity</div>';
            }
        })
        .catch(error => {
            console.error('Error loading recent activity:', error);
            document.getElementById('activity-list').innerHTML = '<div class="error">Error loading recent activity</div>';
        });
}

// Load dataset table
function loadDatasetTable() {
    fetch('/api/datasets?limit=20')
        .then(response => response.json())
        .then(data => {
            const tbody = document.querySelector('#dataset-table tbody');
            
            if (data.datasets && data.datasets.length > 0) {
                tbody.innerHTML = data.datasets.map(dataset => `
                    <tr>
                        <td onclick="window.location.href='/datasets/${dataset.dataset_id}'" style="cursor: pointer;">
                            <div class="dataset-name" title="${escapeHtml(dataset.title || 'Unknown Title')}">
                                ${escapeHtml(dataset.title || 'Unknown Title')}
                            </div>
                        </td>
                        <td>
                            <div class="dataset-agency">${escapeHtml(dataset.agency || 'Unknown Agency')}</div>
                        </td>
                        <td>
                            <div class="dataset-dimensions">
                                ${dataset.row_count !== null && dataset.row_count > 0 ? dataset.row_count.toLocaleString() : 'Computing...'}
                            </div>
                        </td>
                        <td>
                            <div class="dataset-dimensions">
                                ${dataset.column_count !== null && dataset.column_count > 0 ? dataset.column_count.toLocaleString() : 'Computing...'}
                            </div>
                        </td>
                        <td>
                            <span class="status-badge ${dataset.availability || 'unknown'}">
                                ${(dataset.availability || 'unknown').toUpperCase()}
                            </span>
                        </td>
                        <td>
                            <div class="dataset-date">${formatDate(dataset.snapshot_date)}</div>
                        </td>
                        <td>
                            <div class="dataset-actions">
                                <button class="action-btn" onclick="window.location.href='/field-diff-panel?dataset=${dataset.dataset_id}'" title="Field Diff">
                                    DIFF
                                </button>
                                <button class="action-btn" onclick="window.location.href='/content-drift-charts?dataset=${dataset.dataset_id}'" title="Content Drift">
                                    CHART
                                </button>
                                <button class="action-btn" onclick="window.location.href='/change-log-view?dataset=${dataset.dataset_id}'" title="Change Log">
                                    LOG
                                </button>
                            </div>
                        </td>
                    </tr>
                `).join('');
            } else {
                tbody.innerHTML = '<tr><td colspan="7" class="loading">No datasets available</td></tr>';
            }
        })
        .catch(error => {
            console.error('Error loading dataset table:', error);
            document.querySelector('#dataset-table tbody').innerHTML = 
                '<tr><td colspan="7" class="error">Error loading datasets</td></tr>';
        });
}

// Load charts
function loadCharts() {
    loadStatusChart();
    loadAgencyChart();
    loadFormatChart();
    loadQualityChart();
}

// Load status over time chart
function loadStatusChart() {
    const statusChart = document.getElementById('status-chart');
    statusChart.innerHTML = '<div class="loading">Loading status chart...</div>';
    
    fetch('/api/charts/status-over-time')
        .then(response => response.json())
        .then(data => {
            statusChart.innerHTML = '<canvas id="status-chart-canvas"></canvas>';
            
            const ctx = document.getElementById('status-chart-canvas').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Dataset Status Over Time (Last 30 Days)',
                            font: {
                                family: 'Funnel Sans',
                                size: 14,
                                weight: 'bold'
                            }
                        },
                        legend: {
                            position: 'top',
                            labels: {
                                font: {
                                    family: 'Funnel Sans'
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Date',
                                font: {
                                    family: 'Funnel Sans'
                                }
                            },
                            ticks: {
                                font: {
                                    family: 'Funnel Sans'
                                }
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Number of Datasets',
                                font: {
                                    family: 'Funnel Sans'
                                }
                            },
                            ticks: {
                                font: {
                                    family: 'Funnel Sans'
                                }
                            }
                        }
                    }
                }
            });
        })
        .catch(error => {
            console.error('Error loading status chart:', error);
            statusChart.innerHTML = '<div class="error">Error loading status chart</div>';
        });
}

// Load agency distribution chart
function loadAgencyChart() {
    const agencyChart = document.getElementById('agency-chart');
    agencyChart.innerHTML = '<div class="loading">Loading agency chart...</div>';
    
    fetch('/api/charts/agency-distribution')
        .then(response => response.json())
        .then(data => {
            agencyChart.innerHTML = '<canvas id="agency-chart-canvas"></canvas>';
            
            const ctx = document.getElementById('agency-chart-canvas').getContext('2d');
            new Chart(ctx, {
                type: 'doughnut',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Dataset Distribution by Agency (Top 20)',
                            font: {
                                family: 'Funnel Sans',
                                size: 14,
                                weight: 'bold'
                            }
                        },
                        legend: {
                            position: 'right',
                            labels: {
                                font: {
                                    family: 'Funnel Sans'
                                },
                                usePointStyle: true,
                                padding: 15
                            }
                        }
                    }
                }
            });
        })
        .catch(error => {
            console.error('Error loading agency chart:', error);
            agencyChart.innerHTML = '<div class="error">Error loading agency chart</div>';
        });
}

// Load format distribution chart
function loadFormatChart() {
    const formatChart = document.getElementById('format-chart');
    formatChart.innerHTML = '<div class="loading">Loading format chart...</div>';
    
    fetch('/api/charts/format-distribution')
        .then(response => response.json())
        .then(data => {
            formatChart.innerHTML = '<canvas id="format-chart-canvas"></canvas>';
            
            const ctx = document.getElementById('format-chart-canvas').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Dataset Distribution by Format (Top 15)',
                            font: {
                                family: 'Funnel Sans',
                                size: 14,
                                weight: 'bold'
                            }
                        },
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Data Format',
                                font: {
                                    family: 'Funnel Sans'
                                }
                            },
                            ticks: {
                                font: {
                                    family: 'Funnel Sans'
                                },
                                maxRotation: 45
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Number of Datasets',
                                font: {
                                    family: 'Funnel Sans'
                                }
                            },
                            ticks: {
                                font: {
                                    family: 'Funnel Sans'
                                }
                            }
                        }
                    }
                }
            });
        })
        .catch(error => {
            console.error('Error loading format chart:', error);
            formatChart.innerHTML = '<div class="error">Error loading format chart</div>';
        });
}

// Load quality trends chart
function loadQualityChart() {
    const qualityChart = document.getElementById('quality-chart');
    qualityChart.innerHTML = '<div class="loading">Loading quality chart...</div>';
    
    fetch('/api/charts/quality-trends')
        .then(response => response.json())
        .then(data => {
            qualityChart.innerHTML = '<canvas id="quality-chart-canvas"></canvas>';
            
            const ctx = document.getElementById('quality-chart-canvas').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Data Quality Trends (Last 30 Days)',
                            font: {
                                family: 'Funnel Sans',
                                size: 14,
                                weight: 'bold'
                            }
                        },
                        legend: {
                            position: 'top',
                            labels: {
                                font: {
                                    family: 'Funnel Sans'
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Date',
                                font: {
                                    family: 'Funnel Sans'
                                }
                            },
                            ticks: {
                                font: {
                                    family: 'Funnel Sans'
                                }
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Average Quality Score',
                                font: {
                                    family: 'Funnel Sans'
                                }
                            },
                            ticks: {
                                font: {
                                    family: 'Funnel Sans'
                                }
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Quality Coverage (%)',
                                font: {
                                    family: 'Funnel Sans'
                                }
                            },
                            ticks: {
                                font: {
                                    family: 'Funnel Sans'
                                }
                            },
                            grid: {
                                drawOnChartArea: false,
                            },
                        }
                    }
                }
            });
        })
        .catch(error => {
            console.error('Error loading quality chart:', error);
            qualityChart.innerHTML = '<div class="error">Error loading quality chart</div>';
        });
}

// Show error
function showError(message) {
    const container = document.getElementById('stats-grid');
    container.innerHTML = `<div class="error">${message}</div>`;
}

// Format date
function formatDate(dateString) {
    if (!dateString) return 'Unknown';
    return new Date(dateString).toLocaleDateString();
}

// Escape HTML
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Dashboard Search Functions
function handleDashboardSearch(event) {
    if (event.key === 'Enter') {
        performDashboardSearch();
    }
}

function performDashboardSearch() {
    const query = document.getElementById('dashboard-search').value.trim();
    const contentType = document.getElementById('content-type-filter').value;
    const status = document.getElementById('status-filter').value;
    const sortBy = document.getElementById('sort-filter').value;
    
    if (!query) {
        hideSearchResults();
        return;
    }
    
    // Build search parameters
    const params = new URLSearchParams({
        q: query,
        limit: 10
    });
    
    if (contentType) params.append('content_type', contentType);
    if (status) params.append('status', status);
    if (sortBy) params.append('sort', sortBy);
    
    // Perform search
    fetch(`/api/search/?${params.toString()}`)
        .then(response => response.json())
        .then(data => {
            displaySearchResults(data.results || []);
        })
        .catch(error => {
            console.error('Search error:', error);
            showSearchError('Error performing search');
        });
}

function displaySearchResults(datasets) {
    const resultsContainer = document.getElementById('search-results');
    
    if (datasets.length === 0) {
        resultsContainer.innerHTML = '<div class="search-result-item">No datasets found</div>';
    } else {
        resultsContainer.innerHTML = datasets.map(dataset => `
            <div class="search-result-item" onclick="viewDataset('${dataset.id}')">
                <div class="search-result-title">${escapeHtml(dataset.title || 'Unknown Title')}</div>
                <div class="search-result-agency">${escapeHtml(dataset.agency || 'Unknown Agency')}</div>
                <div class="search-result-meta">
                    <span>Rows: ${dataset.row_count ? dataset.row_count.toLocaleString() : 'Unknown'}</span>
                    <span>Columns: ${dataset.column_count ? dataset.column_count.toLocaleString() : 'Unknown'}</span>
                    <span>Status: ${dataset.status || 'Unknown'}</span>
                    <span>Updated: ${dataset.last_updated || 'Unknown'}</span>
                </div>
            </div>
        `).join('');
    }
    
    resultsContainer.style.display = 'block';
}

function hideSearchResults() {
    document.getElementById('search-results').style.display = 'none';
}

function showSearchError(message) {
    const resultsContainer = document.getElementById('search-results');
    resultsContainer.innerHTML = `<div class="search-result-item">${message}</div>`;
    resultsContainer.style.display = 'block';
}

function viewDataset(datasetId) {
    window.location.href = `/dataset/${datasetId}`;
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Initialize dashboard
document.addEventListener('DOMContentLoaded', function() {
    loadDashboardData();
    
    // Refresh data every 30 seconds
    setInterval(loadDashboardData, 30000);
});
</script>
{% endblock %}
