{% extends "layouts/layout.html" %}

{% block title %}Field Diff Panel - Dataset State Historian{% endblock %}

{% block extra_css %}
<style>
.field-diff-container {
    padding: var(--space-6);
    max-width: 1400px;
    margin: 0 auto;
}

.field-diff-header {
    margin-bottom: var(--space-6);
}

.field-diff-title {
    font-size: var(--text-3xl);
    font-weight: var(--font-bold);
    color: var(--gray-900);
    margin-bottom: var(--space-2);
}

.field-diff-subtitle {
    font-size: var(--text-lg);
    color: var(--gray-600);
    margin-bottom: var(--space-4);
}

.field-selector {
    display: flex;
    gap: var(--space-4);
    align-items: center;
    margin-bottom: var(--space-6);
    padding: var(--space-4);
    background: white;
    border: 1px solid var(--gray-200);
}

.field-dropdown {
    padding: var(--space-2) var(--space-3);
    border: 1px solid var(--gray-300);
    border-radius: 0;
    font-size: var(--text-sm);
    font-family: var(--font-family);
    background-color: white;
    min-width: 200px;
}

.field-history-panel {
    background: white;
    border: 1px solid var(--gray-200);
    margin-bottom: var(--space-6);
}

.field-history-header {
    padding: var(--space-4);
    border-bottom: 1px solid var(--gray-200);
    background: var(--gray-50);
}

.field-history-title {
    font-size: var(--text-xl);
    font-weight: var(--font-semibold);
    color: var(--gray-900);
    margin-bottom: var(--space-2);
}

.field-history-meta {
    font-size: var(--text-sm);
    color: var(--gray-600);
}

.field-timeline {
    padding: var(--space-4);
}

.timeline-item {
    display: flex;
    align-items: center;
    padding: var(--space-3);
    border-bottom: 1px solid var(--gray-100);
    transition: background-color var(--transition-fast);
}

.timeline-item:hover {
    background-color: var(--gray-50);
}

.timeline-item:last-child {
    border-bottom: none;
}

.timeline-date {
    font-size: var(--text-sm);
    color: var(--gray-500);
    font-family: var(--font-mono);
    min-width: 120px;
    margin-right: var(--space-4);
}

.timeline-value {
    flex: 1;
    font-size: var(--text-sm);
    color: var(--gray-700);
    font-family: var(--font-mono);
    background: var(--gray-50);
    padding: var(--space-2);
    border-radius: 0;
    word-break: break-all;
}

.timeline-change {
    margin-left: var(--space-4);
    padding: var(--space-1) var(--space-2);
    border-radius: 0;
    font-size: var(--text-xs);
    font-weight: var(--font-medium);
    text-transform: uppercase;
}

.change-added {
    background-color: var(--success);
    color: white;
}

.change-removed {
    background-color: var(--error);
    color: white;
}

.change-modified {
    background-color: var(--warning);
    color: white;
}

.change-unchanged {
    background-color: var(--gray-300);
    color: var(--gray-600);
}

.diff-highlight {
    background-color: #fff3cd;
    padding: 2px 4px;
    border-radius: 2px;
}

.diff-removed {
    background-color: #f8d7da;
    text-decoration: line-through;
}

.diff-added {
    background-color: #d4edda;
}

.sparkline-container {
    width: 100px;
    height: 30px;
    margin-left: var(--space-4);
}

.export-controls {
    display: flex;
    gap: var(--space-2);
    margin-top: var(--space-4);
}

.export-button {
    padding: var(--space-2) var(--space-4);
    background-color: var(--primary);
    color: white;
    border: none;
    border-radius: 0;
    font-size: var(--text-sm);
    font-family: var(--font-family);
    cursor: pointer;
    transition: background-color var(--transition-fast);
}

.export-button:hover {
    background-color: var(--primary-dark);
}

.loading {
    text-align: center;
    padding: var(--space-8);
    color: var(--gray-500);
}

.error {
    background: var(--gray-100);
    color: var(--error);
    padding: var(--space-4);
    border: 1px solid var(--gray-200);
    border-radius: 0;
    margin: var(--space-4) 0;
}
</style>
{% endblock %}

{% block content %}
<div class="field-diff-container">
    <div class="field-diff-header">
        <h1 class="field-diff-title">Field Diff Panel</h1>
        <p class="field-diff-subtitle">Detailed change history for dataset fields</p>
    </div>

    <div class="field-selector">
        <label for="dataset-select">Dataset:</label>
        <select id="dataset-select" class="field-dropdown">
            <option value="">Select a dataset...</option>
        </select>
        
        <label for="field-select">Field:</label>
        <select id="field-select" class="field-dropdown" disabled>
            <option value="">Select a field...</option>
        </select>
        
        <button id="load-history" class="export-button" disabled>Load History</button>
    </div>

    <div class="field-history-panel" id="field-history-panel" style="display: none;">
        <div class="field-history-header">
            <h3 class="field-history-title" id="field-history-title">Field History</h3>
            <div class="field-history-meta" id="field-history-meta">Select a field to view its history</div>
        </div>
        
        <div class="field-timeline" id="field-timeline">
            <div class="loading">Loading field history...</div>
        </div>
        
        <div class="export-controls">
            <button id="export-csv" class="export-button">Export CSV</button>
            <button id="export-json" class="export-button">Export JSON</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
class FieldDiffPanel {
    constructor() {
        this.currentDataset = null;
        this.currentField = null;
        this.fieldHistory = [];
        this.init();
    }

    init() {
        this.loadDatasets();
        this.bindEvents();
    }

    async loadDatasets() {
        try {
            const response = await fetch('/api/datasets?limit=100');
            const data = await response.json();
            
            const select = document.getElementById('dataset-select');
            select.innerHTML = '<option value="">Select a dataset...</option>';
            
            data.datasets.forEach(dataset => {
                const option = document.createElement('option');
                option.value = dataset.dataset_id;
                option.textContent = `${dataset.title || 'Unknown'} (${dataset.agency || 'Unknown Agency'})`;
                select.appendChild(option);
            });
        } catch (error) {
            console.error('Error loading datasets:', error);
        }
    }

    bindEvents() {
        document.getElementById('dataset-select').addEventListener('change', (e) => {
            this.currentDataset = e.target.value;
            if (this.currentDataset) {
                this.loadFields();
            } else {
                this.resetFieldSelect();
            }
        });

        document.getElementById('field-select').addEventListener('change', (e) => {
            this.currentField = e.target.value;
            document.getElementById('load-history').disabled = !this.currentField;
        });

        document.getElementById('load-history').addEventListener('click', () => {
            if (this.currentDataset && this.currentField) {
                this.loadFieldHistory();
            }
        });

        document.getElementById('export-csv').addEventListener('click', () => {
            this.exportData('csv');
        });

        document.getElementById('export-json').addEventListener('click', () => {
            this.exportData('json');
        });
    }

    async loadFields() {
        try {
            const response = await fetch(`/api/dataset/${this.currentDataset}/fields`);
            const data = await response.json();
            
            const select = document.getElementById('field-select');
            select.innerHTML = '<option value="">Select a field...</option>';
            select.disabled = false;
            
            if (data.fields) {
                data.fields.forEach(field => {
                    const option = document.createElement('option');
                    option.value = field.name;
                    option.textContent = `${field.name} (${field.type})`;
                    select.appendChild(option);
                });
            }
        } catch (error) {
            console.error('Error loading fields:', error);
            this.showError('Error loading fields for this dataset');
        }
    }

    resetFieldSelect() {
        const select = document.getElementById('field-select');
        select.innerHTML = '<option value="">Select a field...</option>';
        select.disabled = true;
        document.getElementById('load-history').disabled = true;
        document.getElementById('field-history-panel').style.display = 'none';
    }

    async loadFieldHistory() {
        try {
            const response = await fetch(`/api/dataset/${this.currentDataset}/field-history/${this.currentField}`);
            const data = await response.json();
            
            this.fieldHistory = data.history || [];
            this.renderFieldHistory();
            document.getElementById('field-history-panel').style.display = 'block';
        } catch (error) {
            console.error('Error loading field history:', error);
            this.showError('Error loading field history');
        }
    }

    renderFieldHistory() {
        const timeline = document.getElementById('field-timeline');
        const title = document.getElementById('field-history-title');
        const meta = document.getElementById('field-history-meta');
        
        title.textContent = `Field History: ${this.currentField}`;
        meta.textContent = `${this.fieldHistory.length} changes found`;
        
        if (this.fieldHistory.length === 0) {
            timeline.innerHTML = '<div class="loading">No changes found for this field</div>';
            return;
        }
        
        timeline.innerHTML = this.fieldHistory.map((change, index) => {
            const changeType = this.getChangeType(change);
            const changeClass = `change-${changeType}`;
            
            return `
                <div class="timeline-item">
                    <div class="timeline-date">${this.formatDate(change.date)}</div>
                    <div class="timeline-value">${this.formatValue(change.value)}</div>
                    <div class="timeline-change ${changeClass}">${changeType}</div>
                    ${this.renderSparkline(change)}
                </div>
            `;
        }).join('');
    }

    getChangeType(change) {
        if (change.old_value === null && change.new_value !== null) return 'added';
        if (change.old_value !== null && change.new_value === null) return 'removed';
        if (change.old_value !== change.new_value) return 'modified';
        return 'unchanged';
    }

    formatValue(value) {
        if (value === null) return 'null';
        if (typeof value === 'string' && value.length > 100) {
            return value.substring(0, 100) + '...';
        }
        return String(value);
    }

    formatDate(dateString) {
        return new Date(dateString).toLocaleDateString();
    }

    renderSparkline(change) {
        // Simple sparkline placeholder
        return '<div class="sparkline-container"></div>';
    }

    exportData(format) {
        if (this.fieldHistory.length === 0) {
            alert('No data to export');
            return;
        }
        
        let content, filename, mimeType;
        
        if (format === 'csv') {
            content = this.convertToCSV();
            filename = `${this.currentDataset}_${this.currentField}_history.csv`;
            mimeType = 'text/csv';
        } else {
            content = JSON.stringify(this.fieldHistory, null, 2);
            filename = `${this.currentDataset}_${this.currentField}_history.json`;
            mimeType = 'application/json';
        }
        
        const blob = new Blob([content], { type: mimeType });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        a.click();
        URL.revokeObjectURL(url);
    }

    convertToCSV() {
        const headers = ['Date', 'Old Value', 'New Value', 'Change Type'];
        const rows = this.fieldHistory.map(change => [
            change.date,
            change.old_value || '',
            change.new_value || '',
            this.getChangeType(change)
        ]);
        
        return [headers, ...rows].map(row => 
            row.map(field => `"${String(field).replace(/"/g, '""')}"`).join(',')
        ).join('\n');
    }

    showError(message) {
        const timeline = document.getElementById('field-timeline');
        timeline.innerHTML = `<div class="error">${message}</div>`;
    }
}

// Initialize when page loads
document.addEventListener('DOMContentLoaded', () => {
    new FieldDiffPanel();
});
</script>
{% endblock %}