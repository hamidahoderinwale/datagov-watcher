{% extends "layouts/layout.html" %}

{% block title %}Analytics - Dataset State Historian{% endblock %}

{% block extra_css %}
<style>
.analytics-container {
    padding: var(--space-6);
    max-width: 1400px;
    margin: 0 auto;
}

.analytics-header {
    margin-bottom: var(--space-8);
}

.analytics-title {
    font-size: var(--text-4xl);
    font-weight: var(--font-bold);
    color: var(--gray-900);
    margin-bottom: var(--space-2);
}

.analytics-subtitle {
    font-size: var(--text-lg);
    color: var(--gray-600);
    margin-bottom: var(--space-6);
}

.analytics-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: var(--space-6);
    margin-bottom: var(--space-8);
}

.chart-container {
    background: white;
    border: 1px solid var(--gray-200);
    padding: var(--space-6);
}

.chart-title {
    font-size: var(--text-xl);
    font-weight: var(--font-semibold);
    color: var(--gray-900);
    margin-bottom: var(--space-4);
    padding-bottom: var(--space-2);
    border-bottom: 1px solid var(--gray-200);
}

.chart-content {
    height: 300px;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
}

.chart-placeholder {
    color: var(--gray-500);
    text-align: center;
}

.chart-controls {
    display: flex;
    gap: var(--space-4);
    margin-bottom: var(--space-4);
    flex-wrap: wrap;
}

.control-group {
    display: flex;
    flex-direction: column;
    gap: var(--space-2);
}

.control-label {
    font-size: var(--text-sm);
    font-weight: var(--font-medium);
    color: var(--gray-700);
}

.control-select {
    padding: var(--space-2) var(--space-3);
    border: 1px solid var(--gray-300);
    border-radius: 0;
    font-size: var(--text-sm);
    background: white;
}

.metrics-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: var(--space-4);
    margin-bottom: var(--space-8);
}

.metric-card {
    background: white;
    border: 1px solid var(--gray-200);
    padding: var(--space-6);
    text-align: center;
    transition: all var(--transition-fast);
}

.metric-card:hover {
    border-color: var(--primary);
    box-shadow: var(--shadow-md);
}

.metric-value {
    font-size: var(--text-3xl);
    font-weight: var(--font-bold);
    color: var(--primary);
    margin-bottom: var(--space-2);
}

.metric-label {
    font-size: var(--text-sm);
    color: var(--gray-600);
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.metric-change {
    font-size: var(--text-xs);
    color: var(--gray-500);
    margin-top: var(--space-1);
}

.metric-change.positive {
    color: var(--success);
}

.metric-change.negative {
    color: var(--error);
}

.trend-chart {
    background: white;
    border: 1px solid var(--gray-200);
    padding: var(--space-6);
    margin-bottom: var(--space-8);
}

.trend-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-4);
}

.trend-title {
    font-size: var(--text-xl);
    font-weight: var(--font-semibold);
    color: var(--gray-900);
}

.trend-controls {
    display: flex;
    gap: var(--space-4);
}

.agency-analysis {
    background: white;
    border: 1px solid var(--gray-200);
    padding: var(--space-6);
    margin-bottom: var(--space-8);
}

.agency-list {
    display: flex;
    flex-direction: column;
    gap: var(--space-3);
    margin-top: var(--space-4);
}

.agency-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-3);
    background: var(--gray-50);
    border: 1px solid var(--gray-200);
}

.agency-name {
    font-weight: var(--font-medium);
    color: var(--gray-900);
}

.agency-stats {
    display: flex;
    gap: var(--space-4);
    font-size: var(--text-sm);
    color: var(--gray-600);
}

.agency-bar {
    height: 4px;
    background: var(--gray-200);
    margin-top: var(--space-2);
    border-radius: 0;
}

.agency-progress {
    height: 100%;
    background: var(--primary);
    border-radius: 0;
    transition: width var(--transition-fast);
}

.loading {
    text-align: center;
    padding: var(--space-8);
    color: var(--gray-500);
}

.error {
    background: var(--gray-100);
    color: var(--gray-700);
    padding: var(--space-4);
    border: 1px solid var(--gray-300);
    margin: var(--space-4) 0;
    border-radius: 0;
}

.export-section {
    background: white;
    border: 1px solid var(--gray-200);
    padding: var(--space-6);
    margin-bottom: var(--space-8);
}

.export-buttons {
    display: flex;
    gap: var(--space-4);
    flex-wrap: wrap;
}

.export-button {
    padding: var(--space-3) var(--space-6);
    background: var(--primary);
    color: white;
    border: none;
    border-radius: 0;
    cursor: pointer;
    font-weight: var(--font-medium);
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: var(--space-2);
    transition: all var(--transition-fast);
}

.export-button:hover {
    background: var(--primary-dark);
    color: white;
    text-decoration: none;
}

.export-button.secondary {
    background: var(--gray-100);
    color: var(--gray-700);
    border: 1px solid var(--gray-300);
}

.export-button.secondary:hover {
    background: var(--gray-200);
    color: var(--gray-900);
}

/* Datasets Section */
.datasets-section {
    background: white;
    border: 1px solid var(--gray-200);
    padding: var(--space-6);
    margin-bottom: var(--space-8);
}

.datasets-controls {
    display: flex;
    gap: var(--space-4);
    margin-bottom: var(--space-6);
    flex-wrap: wrap;
}

.datasets-table-container {
    overflow-x: auto;
    margin-bottom: var(--space-4);
}

.datasets-table {
    width: 100%;
    border-collapse: collapse;
    min-width: 1000px;
}

.datasets-table th,
.datasets-table td {
    padding: var(--space-3) var(--space-4);
    text-align: left;
    border-bottom: 1px solid var(--gray-200);
    font-size: var(--text-sm);
}

.datasets-table th {
    background: var(--gray-50);
    font-weight: var(--font-semibold);
    color: var(--gray-700);
    font-size: var(--text-xs);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    position: sticky;
    top: 0;
    z-index: 10;
}

.datasets-table tbody tr:hover {
    background-color: var(--gray-50);
}

.datasets-table .status-available {
    color: var(--success);
    font-weight: var(--font-semibold);
}

.datasets-table .status-unavailable {
    color: var(--error);
    font-weight: var(--font-semibold);
}

.datasets-table .status-error {
    color: var(--warning);
    font-weight: var(--font-semibold);
}

.preview-button {
    padding: var(--space-1) var(--space-2);
    background: var(--primary);
    color: white;
    border: none;
    border-radius: 0;
    cursor: pointer;
    font-size: var(--text-xs);
    font-weight: var(--font-medium);
    transition: all var(--transition-fast);
}

.preview-button:hover {
    background: var(--primary-dark);
}

.preview-modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
}

.preview-modal-content {
    background-color: white;
    margin: 5% auto;
    padding: 0;
    border: none;
    border-radius: 0;
    width: 90%;
    max-width: 1000px;
    max-height: 80vh;
    overflow: hidden;
    box-shadow: var(--shadow-xl);
}

.preview-modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-4) var(--space-6);
    border-bottom: 1px solid var(--gray-200);
    background: var(--gray-50);
}

.preview-modal-header h3 {
    margin: 0;
    font-size: var(--text-lg);
    font-weight: var(--font-semibold);
    color: var(--gray-900);
}

.preview-modal-close {
    background: none;
    border: none;
    font-size: var(--text-xl);
    cursor: pointer;
    color: var(--gray-500);
    padding: var(--space-2);
    line-height: 1;
    transition: color var(--transition-fast);
}

.preview-modal-close:hover {
    color: var(--gray-700);
}

.preview-modal-body {
    padding: var(--space-6);
    max-height: 60vh;
    overflow-y: auto;
}

.preview-table {
    width: 100%;
    border-collapse: collapse;
    font-size: var(--text-sm);
}

.preview-table th,
.preview-table td {
    padding: var(--space-2) var(--space-3);
    text-align: left;
    border-bottom: 1px solid var(--gray-200);
}

.preview-table th {
    background: var(--gray-50);
    font-weight: var(--font-semibold);
    color: var(--gray-700);
}

.preview-table tbody tr:hover {
    background-color: var(--gray-50);
}

.no-preview {
    color: var(--gray-500);
    font-style: italic;
    text-align: center;
    padding: var(--space-4);
}

/* Chart Visualizations */
.trend-chart-container {
    padding: var(--space-4);
}

/* Chart.js will handle all styling for the trends chart */

/* Status Chart */
.status-chart-container {
    padding: var(--space-4);
}

.status-item {
    display: flex;
    align-items: center;
    margin-bottom: var(--space-3);
}

.status-label {
    width: 120px;
    font-size: var(--text-sm);
    font-weight: var(--font-medium);
    color: var(--gray-700);
}

.status-bar {
    flex: 1;
    height: 20px;
    background: var(--gray-200);
    border-radius: 0;
    margin: 0 var(--space-3);
    overflow: hidden;
}

.status-fill {
    height: 100%;
    transition: width var(--transition-fast);
}

.status-fill.status-available {
    background: var(--success);
}

.status-fill.status-unavailable {
    background: var(--error);
}

.status-fill.status-unknown {
    background: var(--warning);
}

.status-count {
    width: 100px;
    font-size: var(--text-sm);
    color: var(--gray-600);
    text-align: right;
}

/* Format Chart */
.format-chart-container {
    padding: var(--space-4);
}

.format-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-2) 0;
    border-bottom: 1px solid var(--gray-200);
}

.format-item:last-child {
    border-bottom: none;
}

.format-label {
    font-size: var(--text-sm);
    font-weight: var(--font-medium);
    color: var(--gray-700);
}

.format-count {
    font-size: var(--text-sm);
    color: var(--gray-600);
}

/* Change Chart */
.change-chart-container {
    padding: var(--space-4);
}

.change-summary {
    text-align: center;
    margin-bottom: var(--space-4);
    padding: var(--space-3);
    background: var(--gray-50);
    border-radius: 0;
}

.change-total {
    font-size: var(--text-lg);
    font-weight: var(--font-semibold);
    color: var(--gray-900);
    margin-bottom: var(--space-1);
}

.change-period {
    font-size: var(--text-sm);
    color: var(--gray-600);
}

.change-breakdown {
    display: flex;
    flex-direction: column;
    gap: var(--space-2);
}

.change-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-2);
    background: var(--gray-50);
    border-radius: 0;
}

.change-type {
    font-size: var(--text-sm);
    font-weight: var(--font-medium);
    color: var(--gray-700);
}

.change-count {
    font-size: var(--text-sm);
    color: var(--gray-600);
}

/* Quality Chart */
.quality-chart-container {
    padding: var(--space-4);
}

.quality-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-2) 0;
    border-bottom: 1px solid var(--gray-200);
}

.quality-item:last-child {
    border-bottom: none;
}

.quality-label {
    font-size: var(--text-sm);
    font-weight: var(--font-medium);
    color: var(--gray-700);
}

.quality-value {
    font-size: var(--text-sm);
    font-weight: var(--font-semibold);
    color: var(--primary);
}

/* Additional utility classes */
.export-description {
    color: var(--gray-600);
    margin-bottom: var(--space-4);
}

.view-details-button {
    padding: var(--space-1) var(--space-2);
    font-size: var(--text-xs);
}

.preview-summary {
    text-align: center;
    color: var(--gray-500);
    margin-top: var(--space-4);
}
</style>
{% endblock %}

{% block content %}
<div class="analytics-container">
    <div class="analytics-header">
        <h1 class="analytics-title">Advanced Analytics</h1>
        <p class="analytics-subtitle">Comprehensive analysis of dataset trends, agency performance, and system metrics</p>
    </div>

    <!-- Key Metrics -->
    <div class="metrics-grid" id="metrics-grid">
        <div class="metric-card">
            <div class="metric-value" id="total-datasets">-</div>
            <div class="metric-label">Total Datasets</div>
            <div class="metric-change" id="datasets-change">Loading...</div>
        </div>
        <div class="metric-card">
            <div class="metric-value" id="available-datasets">-</div>
            <div class="metric-label">Available</div>
            <div class="metric-change" id="available-change">Loading...</div>
        </div>
        <div class="metric-card">
            <div class="metric-value" id="total-snapshots">-</div>
            <div class="metric-label">Total Snapshots</div>
            <div class="metric-change" id="snapshots-change">Loading...</div>
        </div>
        <div class="metric-card">
            <div class="metric-value" id="change-events">-</div>
            <div class="metric-label">Change Events</div>
            <div class="metric-change" id="changes-change">Loading...</div>
        </div>
        <div class="metric-card">
            <div class="metric-value" id="agencies-count">-</div>
            <div class="metric-label">Agencies</div>
            <div class="metric-change" id="agencies-change">Loading...</div>
        </div>
        <div class="metric-card">
            <div class="metric-value" id="avg-availability">-</div>
            <div class="metric-label">Avg Availability</div>
            <div class="metric-change" id="availability-change">Loading...</div>
        </div>
    </div>

    <!-- Trend Analysis -->
    <div class="trend-chart">
        <div class="trend-header">
            <h2 class="trend-title">Dataset Trends Over Time</h2>
            <div class="trend-controls">
                <div class="control-group">
                    <label class="control-label">Time Period</label>
                    <select class="control-select" id="time-period">
                        <option value="7">Last 7 Days</option>
                        <option value="30" selected>Last 30 Days</option>
                        <option value="90">Last 90 Days</option>
                        <option value="365">Last Year</option>
                    </select>
                </div>
                <div class="control-group">
                    <label class="control-label">Metric</label>
                    <select class="control-select" id="trend-metric">
                        <option value="datasets">Total Datasets</option>
                        <option value="availability">Availability</option>
                        <option value="changes">Changes</option>
                        <option value="snapshots">Snapshots</option>
                    </select>
                </div>
            </div>
        </div>
        <div class="chart-content" id="trend-chart">
            <div class="chart-placeholder">Loading trend data...</div>
        </div>
    </div>

    <!-- Agency Analysis -->
    <div class="agency-analysis">
        <h2 class="chart-title">Agency Performance</h2>
        <div class="chart-controls">
            <div class="control-group">
                <label class="control-label">Sort By</label>
                <select class="control-select" id="agency-sort">
                    <option value="datasets">Total Datasets</option>
                    <option value="availability">Availability %</option>
                    <option value="changes">Change Events</option>
                </select>
            </div>
            <div class="control-group">
                <label class="control-label">Limit</label>
                <select class="control-select" id="agency-limit">
                    <option value="10">Top 10</option>
                    <option value="20" selected>Top 20</option>
                    <option value="50">Top 50</option>
                </select>
            </div>
        </div>
        <div class="agency-list" id="agency-list">
            <div class="loading">Loading agency data...</div>
        </div>
    </div>

    <!-- Chart Grid -->
    <div class="analytics-grid">
        <div class="chart-container">
            <h3 class="chart-title">Status Distribution</h3>
            <div class="chart-content" id="status-chart">
                <div class="chart-placeholder">Loading status data...</div>
            </div>
        </div>
        
        <div class="chart-container">
            <h3 class="chart-title">Format Distribution</h3>
            <div class="chart-content" id="format-chart">
                <div class="chart-placeholder">Loading format data...</div>
            </div>
        </div>
        
        <div class="chart-container">
            <h3 class="chart-title">Change Frequency</h3>
            <div class="chart-content" id="change-chart">
                <div class="chart-placeholder">Loading change data...</div>
            </div>
        </div>
        
        <div class="chart-container">
            <h3 class="chart-title">Data Quality Score</h3>
            <div class="chart-content" id="quality-chart">
                <div class="chart-placeholder">Loading quality data...</div>
            </div>
        </div>
    </div>

    <!-- All Datasets Section -->
    <div class="datasets-section">
        <h2 class="chart-title">All Datasets</h2>
        <div class="datasets-controls">
            <div class="control-group">
                <label class="control-label">Search</label>
                <input type="text" class="control-select" id="dataset-search" placeholder="Search datasets...">
            </div>
            <div class="control-group">
                <label class="control-label">Agency</label>
                <select class="control-select" id="agency-filter">
                    <option value="">All Agencies</option>
                </select>
            </div>
            <div class="control-group">
                <label class="control-label">Status</label>
                <select class="control-select" id="status-filter">
                    <option value="">All Status</option>
                    <option value="available">Available</option>
                    <option value="unavailable">Unavailable</option>
                    <option value="error">Error</option>
                </select>
            </div>
            <div class="control-group">
                <label class="control-label">Per Page</label>
                <select class="control-select" id="per-page">
                    <option value="20">20</option>
                    <option value="50" selected>50</option>
                    <option value="100">100</option>
                </select>
            </div>
        </div>
        
        <div class="datasets-table-container">
            <table class="datasets-table" id="datasets-table">
                <thead>
                    <tr>
                        <th>Dataset ID</th>
                        <th>Title</th>
                        <th>Agency</th>
                        <th>Status</th>
                        <th>Last Checked</th>
                        <th>Rows</th>
                        <th>Format</th>
                        <th>Preview</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="datasets-tbody">
                    <tr>
                        <td colspan="9" class="loading">Loading datasets...</td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <div class="pagination" id="datasets-pagination">
            <!-- Pagination will be populated by JavaScript -->
        </div>
    </div>

    <!-- Export Section -->
    <div class="export-section">
        <h2 class="chart-title">Export Data</h2>
        <p class="export-description">
            Export analytics data in various formats for further analysis
        </p>
        <div class="export-buttons">
            <button class="export-button" onclick="exportData('csv')">
                ANALYTICS Export CSV
            </button>
            <button class="export-button" onclick="exportData('json')">
                FILE Export JSON
            </button>
            <button class="export-button secondary" onclick="exportData('pdf')">
                LIST Export PDF Report
            </button>
            <button class="export-button secondary" onclick="exportData('excel')">
                GROWTH Export Excel
            </button>
        </div>
    </div>
</div>

<!-- Preview Modal -->
<div id="preview-modal" class="preview-modal">
    <div class="preview-modal-content">
        <div class="preview-modal-header">
            <h3 id="preview-modal-title">Dataset Preview</h3>
            <button class="preview-modal-close" onclick="closePreviewModal()">&times;</button>
        </div>
        <div class="preview-modal-body" id="preview-modal-body">
            <!-- Preview content will be loaded here -->
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Global variables for datasets
let currentPage = 1;
let totalPages = 1;
let currentFilters = {
    search: '',
    agency: '',
    status: '',
    perPage: 50
};

// Load analytics data
function loadAnalyticsData() {
    loadMetrics();
    loadTrendData();
    loadAgencyData();
    loadChartData();
    loadDatasets();
    loadAgencyOptions();
}

// Load key metrics
function loadMetrics() {
    fetch('/api/stats')
        .then(response => response.json())
        .then(data => {
            document.getElementById('total-datasets').textContent = data.total_datasets || '0';
            document.getElementById('available-datasets').textContent = data.availability_stats?.available || '0';
            document.getElementById('total-snapshots').textContent = data.total_snapshots || '0';
            document.getElementById('change-events').textContent = data.total_changes || '0';
            document.getElementById('agencies-count').textContent = data.agencies_count || '0';
            
            // Calculate average availability
            const total = data.total_datasets || 0;
            const available = data.availability_stats?.available || 0;
            const avgAvailability = total > 0 ? Math.round((available / total) * 100) : 0;
            document.getElementById('avg-availability').textContent = `${avgAvailability}%`;
            
            // Update change indicators
            updateChangeIndicator('datasets-change', data.datasets_change);
            updateChangeIndicator('available-change', data.available_change);
            updateChangeIndicator('snapshots-change', data.snapshots_change);
            updateChangeIndicator('changes-change', data.changes_change);
            updateChangeIndicator('agencies-change', data.agencies_change);
            updateChangeIndicator('availability-change', data.availability_change);
        })
        .catch(error => {
            console.error('Error loading metrics:', error);
        });
}

// Update change indicator
function updateChangeIndicator(elementId, change) {
    const element = document.getElementById(elementId);
    if (change && change !== 0) {
        element.textContent = `${change > 0 ? '+' : ''}${change} from last week`;
        element.className = `metric-change ${change > 0 ? 'positive' : 'negative'}`;
    } else {
        element.textContent = 'No change';
        element.className = 'metric-change';
    }
}

// Load trend data
function loadTrendData() {
    const timePeriod = document.getElementById('time-period').value;
    const metric = document.getElementById('trend-metric').value;
    
    // Fetch real trend data
    fetch(`/api/analytics/trends?period=${timePeriod}&metric=${metric}`)
        .then(response => response.json())
        .then(data => {
            renderTrendChart(data, metric, timePeriod);
        })
        .catch(error => {
            console.error('Error loading trend data:', error);
            const chart = document.getElementById('trend-chart');
            chart.innerHTML = `
                <div class="chart-placeholder">
                    Error loading trend data for ${metric} over last ${timePeriod} days
                </div>
            `;
        });
}

// Load agency data
function loadAgencyData() {
    const sortBy = document.getElementById('agency-sort').value;
    const limit = parseInt(document.getElementById('agency-limit').value);
    
    fetch('/api/agencies')
        .then(response => response.json())
        .then(data => {
            if (data.agencies && data.agencies.length > 0) {
                displayAgencyData(data.agencies.slice(0, limit));
            } else {
                document.getElementById('agency-list').innerHTML = '<div class="loading">No agency data available</div>';
            }
        })
        .catch(error => {
            console.error('Error loading agency data:', error);
            document.getElementById('agency-list').innerHTML = '<div class="error">Error loading agency data</div>';
        });
}

// Display agency data
function displayAgencyData(agencies) {
    const container = document.getElementById('agency-list');
    
    container.innerHTML = agencies.map(agency => {
        const maxDatasets = Math.max(...agencies.map(a => a.dataset_count));
        const percentage = (agency.dataset_count / maxDatasets) * 100;
        
        return `
            <div class="agency-item">
                <div>
                    <div class="agency-name">${escapeHtml(agency.name)}</div>
                    <div class="agency-bar">
                        <div class="agency-progress" data-width="${percentage}"></div>
                    </div>
                </div>
                <div class="agency-stats">
                    <span>${agency.dataset_count} datasets</span>
                    <span>${agency.availability_percentage || 0}% available</span>
                </div>
            </div>
        `;
    }).join('');
    
    // Apply dynamic styles
    setTimeout(() => {
        container.querySelectorAll('.agency-progress[data-width]').forEach(progress => {
            const width = progress.getAttribute('data-width');
            progress.style.width = `${width}%`;
        });
    }, 0);
}

// Render trend chart using Chart.js
function renderTrendChart(data, metric, timePeriod) {
    const chartElement = document.getElementById('trend-chart');
    
    if (!data || !data.labels || data.labels.length === 0) {
        chartElement.innerHTML = `
            <div class="chart-placeholder">
                No trend data available for ${metric} over last ${timePeriod} days
            </div>
        `;
        return;
    }
    
    // Destroy existing chart if it exists
    if (window.trendChart) {
        window.trendChart.destroy();
    }
    
    // Create canvas element
    chartElement.innerHTML = '<canvas id="trend-canvas"></canvas>';
    const canvas = document.getElementById('trend-canvas');
    const ctx = canvas.getContext('2d');
    
    // Set canvas size
    canvas.width = chartElement.offsetWidth;
    canvas.height = chartElement.offsetHeight;
    
    // Create Chart.js chart
    window.trendChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: data.labels,
            datasets: data.datasets.map((dataset, index) => ({
                label: dataset.label,
                data: dataset.data,
                borderColor: ['#3b82f6', '#10b981', '#ef4444', '#f59e0b'][index] || '#6b7280',
                backgroundColor: ['rgba(59, 130, 246, 0.1)', 'rgba(16, 185, 129, 0.1)', 'rgba(239, 68, 68, 0.1)', 'rgba(245, 158, 11, 0.1)'][index] || 'rgba(107, 114, 128, 0.1)',
                tension: 0.4,
                fill: true,
                pointRadius: 4,
                pointHoverRadius: 6
            }))
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: `${metric.charAt(0).toUpperCase() + metric.slice(1)} Trends (Last ${timePeriod} Days)`,
                    font: {
                        size: 16,
                        weight: 'bold'
                    }
                },
                legend: {
                    display: true,
                    position: 'top'
                },
                tooltip: {
                    mode: 'index',
                    intersect: false,
                    callbacks: {
                        label: function(context) {
                            return `${context.dataset.label}: ${context.parsed.y.toLocaleString()}`;
                        }
                    }
                }
            },
            scales: {
                x: {
                    display: true,
                    title: {
                        display: true,
                        text: 'Date'
                    },
                    grid: {
                        color: '#e5e7eb'
                    }
                },
                y: {
                    display: true,
                    title: {
                        display: true,
                        text: metric.charAt(0).toUpperCase() + metric.slice(1)
                    },
                    beginAtZero: true,
                    grid: {
                        color: '#e5e7eb'
                    },
                    ticks: {
                        callback: function(value) {
                            return value.toLocaleString();
                        }
                    }
                }
            },
            interaction: {
                mode: 'nearest',
                axis: 'x',
                intersect: false
            }
        }
    });
}

// Load chart data
function loadChartData() {
    // Load status distribution
    fetch('/api/analytics/status-distribution')
        .then(response => response.json())
        .then(data => {
            renderStatusChart(data);
        })
        .catch(error => {
            console.error('Error loading status data:', error);
            document.getElementById('status-chart').innerHTML = `
                <div class="chart-placeholder">Error loading status distribution</div>
            `;
        });
    
    // Load format distribution
    fetch('/api/analytics/format-distribution')
        .then(response => response.json())
        .then(data => {
            renderFormatChart(data);
        })
        .catch(error => {
            console.error('Error loading format data:', error);
            document.getElementById('format-chart').innerHTML = `
                <div class="chart-placeholder">Error loading format distribution</div>
            `;
        });
    
    // Load change frequency
    fetch('/api/analytics/change-frequency')
        .then(response => response.json())
        .then(data => {
            renderChangeChart(data);
        })
        .catch(error => {
            console.error('Error loading change data:', error);
            document.getElementById('change-chart').innerHTML = `
                <div class="chart-placeholder">Error loading change frequency</div>
            `;
        });
    
    // Load data quality
    fetch('/api/analytics/quality-metrics')
        .then(response => response.json())
        .then(data => {
            renderQualityChart(data);
        })
        .catch(error => {
            console.error('Error loading quality data:', error);
            document.getElementById('quality-chart').innerHTML = `
                <div class="chart-placeholder">Error loading quality metrics</div>
            `;
        });
}

// Render status distribution chart
function renderStatusChart(data) {
    const chart = document.getElementById('status-chart');
    
    if (!data || !data.distribution) {
        chart.innerHTML = '<div class="chart-placeholder">No status data available</div>';
        return;
    }
    
    const total = Object.values(data.distribution).reduce((a, b) => a + b, 0);
    let chartHTML = '<div class="status-chart-container">';
    
    Object.entries(data.distribution).forEach(([status, count]) => {
        const percentage = ((count / total) * 100).toFixed(1);
        chartHTML += `
            <div class="status-item">
                <div class="status-label">${status}</div>
                <div class="status-bar">
                    <div class="status-fill status-${status}" data-width="${percentage}"></div>
                </div>
                <div class="status-count">${count.toLocaleString()} (${percentage}%)</div>
            </div>
        `;
    });
    
    chartHTML += '</div>';
    chart.innerHTML = chartHTML;
    
    // Apply dynamic styles
    setTimeout(() => {
        chart.querySelectorAll('.status-fill[data-width]').forEach(fill => {
            const width = fill.getAttribute('data-width');
            fill.style.width = `${width}%`;
        });
    }, 0);
}

// Render format distribution chart
function renderFormatChart(data) {
    const chart = document.getElementById('format-chart');
    
    if (!data || !data.distribution) {
        chart.innerHTML = '<div class="chart-placeholder">No format data available</div>';
        return;
    }
    
    const total = Object.values(data.distribution).reduce((a, b) => a + b, 0);
    let chartHTML = '<div class="format-chart-container">';
    
    Object.entries(data.distribution).forEach(([format, count]) => {
        const percentage = ((count / total) * 100).toFixed(1);
        chartHTML += `
            <div class="format-item">
                <div class="format-label">${format}</div>
                <div class="format-count">${count.toLocaleString()} (${percentage}%)</div>
            </div>
        `;
    });
    
    chartHTML += '</div>';
    chart.innerHTML = chartHTML;
}

// Render change frequency chart
function renderChangeChart(data) {
    const chart = document.getElementById('change-chart');
    
    if (!data || !data.frequency) {
        chart.innerHTML = '<div class="chart-placeholder">No change data available</div>';
        return;
    }
    
    let chartHTML = `
        <div class="change-chart-container">
            <div class="change-summary">
                <div class="change-total">${data.total_changes.toLocaleString()} Total Changes</div>
                <div class="change-period">Last 30 days</div>
            </div>
            <div class="change-breakdown">
    `;
    
    Object.entries(data.frequency).forEach(([type, count]) => {
        chartHTML += `
            <div class="change-item">
                <div class="change-type">${type}</div>
                <div class="change-count">${count.toLocaleString()}</div>
            </div>
        `;
    });
    
    chartHTML += '</div></div>';
    chart.innerHTML = chartHTML;
}

// Render quality metrics chart
function renderQualityChart(data) {
    const chart = document.getElementById('quality-chart');
    
    if (!data || !data.metrics) {
        chart.innerHTML = '<div class="chart-placeholder">No quality data available</div>';
        return;
    }
    
    let chartHTML = '<div class="quality-chart-container">';
    
    Object.entries(data.metrics).forEach(([metric, value]) => {
        const percentage = typeof value === 'number' ? value.toFixed(1) : value;
        chartHTML += `
            <div class="quality-item">
                <div class="quality-label">${metric.replace(/_/g, ' ').toUpperCase()}</div>
                <div class="quality-value">${percentage}${typeof value === 'number' ? '%' : ''}</div>
            </div>
        `;
    });
    
    chartHTML += '</div>';
    chart.innerHTML = chartHTML;
}

// Export data
function exportData(format) {
    const timePeriod = document.getElementById('time-period').value;
    const metric = document.getElementById('trend-metric').value;
    
    // Create export URL
    const params = new URLSearchParams({
        format: format,
        time_period: timePeriod,
        metric: metric
    });
    
    // For now, show alert - in real implementation, you'd trigger download
    alert(`Exporting ${format.toUpperCase()} data for ${metric} over last ${timePeriod} days...`);
    
    // In real implementation:
    // window.open(`/api/export/analytics?${params}`, '_blank');
}

// Escape HTML
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Load datasets with pagination
function loadDatasets(page = 1) {
    const params = new URLSearchParams({
        page: page,
        limit: currentFilters.perPage,
        search: currentFilters.search,
        agency: currentFilters.agency,
        status: currentFilters.status
    });
    
    fetch(`/api/datasets?${params}`)
        .then(response => response.json())
        .then(data => {
            displayDatasets(data.datasets || []);
            updatePagination(data.total || 0, data.limit || 50, page);
        })
        .catch(error => {
            console.error('Error loading datasets:', error);
            document.getElementById('datasets-tbody').innerHTML = 
                '<tr><td colspan="9" class="error">Error loading datasets</td></tr>';
        });
}

// Display datasets in table
function displayDatasets(datasets) {
    const tbody = document.getElementById('datasets-tbody');
    
    if (datasets.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" class="loading">No datasets found</td></tr>';
        return;
    }
    
    tbody.innerHTML = datasets.map(dataset => `
        <tr>
            <td>${escapeHtml(dataset.dataset_id || 'N/A')}</td>
            <td>${escapeHtml(dataset.title || 'N/A')}</td>
            <td>${escapeHtml(dataset.agency || 'N/A')}</td>
            <td class="status-${dataset.availability || 'unknown'}">${dataset.availability || 'Unknown'}</td>
            <td>${dataset.last_checked ? new Date(dataset.last_checked).toLocaleDateString() : 'N/A'}</td>
            <td>${dataset.row_count ? dataset.row_count.toLocaleString() : 'N/A'}</td>
            <td>${dataset.resource_format || 'N/A'}</td>
            <td>
                <button class="preview-button" onclick="showDatasetPreview('${dataset.dataset_id}')">
                    Preview
                </button>
            </td>
            <td>
                <a href="/dataset/${dataset.dataset_id}" class="export-button secondary view-details-button">
                    View Details
                </a>
            </td>
        </tr>
    `).join('');
}

// Update pagination
function updatePagination(total, limit, currentPage) {
    const totalPages = Math.ceil(total / limit);
    const pagination = document.getElementById('datasets-pagination');
    
    if (totalPages <= 1) {
        pagination.innerHTML = '';
        return;
    }
    
    let paginationHTML = '';
    
    // Previous button
    if (currentPage > 1) {
        paginationHTML += `<button onclick="loadDatasets(${currentPage - 1})">Previous</button>`;
    }
    
    // Page numbers
    const startPage = Math.max(1, currentPage - 2);
    const endPage = Math.min(totalPages, currentPage + 2);
    
    for (let i = startPage; i <= endPage; i++) {
        const activeClass = i === currentPage ? 'active' : '';
        paginationHTML += `<button class="${activeClass}" onclick="loadDatasets(${i})">${i}</button>`;
    }
    
    // Next button
    if (currentPage < totalPages) {
        paginationHTML += `<button onclick="loadDatasets(${currentPage + 1})">Next</button>`;
    }
    
    pagination.innerHTML = paginationHTML;
}

// Load agency options for filter
function loadAgencyOptions() {
    fetch('/api/agencies')
        .then(response => response.json())
        .then(data => {
            const select = document.getElementById('agency-filter');
            select.innerHTML = '<option value="">All Agencies</option>';
            
            if (data.agencies) {
                data.agencies.forEach(agency => {
                    const option = document.createElement('option');
                    option.value = agency.name;
                    option.textContent = agency.name;
                    select.appendChild(option);
                });
            }
        })
        .catch(error => {
            console.error('Error loading agencies:', error);
        });
}

// Show dataset preview
function showDatasetPreview(datasetId) {
    const modal = document.getElementById('preview-modal');
    const title = document.getElementById('preview-modal-title');
    const body = document.getElementById('preview-modal-body');
    
    title.textContent = `Dataset Preview: ${datasetId}`;
    body.innerHTML = '<div class="loading">Loading preview...</div>';
    modal.style.display = 'block';
    
    // Fetch dataset preview data
    fetch(`/api/dataset/${datasetId}/preview`)
        .then(response => response.json())
        .then(data => {
            if (data.preview && data.preview.length > 0) {
                displayPreviewData(data.preview, data.columns);
            } else {
                body.innerHTML = '<div class="no-preview">No preview data available for this dataset</div>';
            }
        })
        .catch(error => {
            console.error('Error loading preview:', error);
            body.innerHTML = '<div class="no-preview">Error loading preview data</div>';
        });
}

// Display preview data in modal
function displayPreviewData(previewData, columns) {
    const body = document.getElementById('preview-modal-body');
    
    if (!previewData || previewData.length === 0) {
        body.innerHTML = '<div class="no-preview">No data available for preview</div>';
        return;
    }
    
    // Create table header
    let tableHTML = '<table class="preview-table"><thead><tr>';
    if (columns && columns.length > 0) {
        columns.forEach(col => {
            tableHTML += `<th>${escapeHtml(col)}</th>`;
        });
    } else {
        // Use first row keys as headers
        const firstRow = previewData[0];
        Object.keys(firstRow).forEach(key => {
            tableHTML += `<th>${escapeHtml(key)}</th>`;
        });
    }
    tableHTML += '</tr></thead><tbody>';
    
    // Add data rows (limit to 5 rows)
    const rowsToShow = previewData.slice(0, 5);
    rowsToShow.forEach(row => {
        tableHTML += '<tr>';
        Object.values(row).forEach(value => {
            const displayValue = value !== null && value !== undefined ? escapeHtml(String(value)) : 'N/A';
            tableHTML += `<td>${displayValue}</td>`;
        });
        tableHTML += '</tr>';
    });
    
    tableHTML += '</tbody></table>';
    
    if (previewData.length > 5) {
        tableHTML += `<p class="preview-summary">
            Showing first 5 rows of ${previewData.length} total rows
        </p>`;
    }
    
    body.innerHTML = tableHTML;
}

// Close preview modal
function closePreviewModal() {
    document.getElementById('preview-modal').style.display = 'none';
}

// Event listeners
document.addEventListener('DOMContentLoaded', function() {
    loadAnalyticsData();
    
    // Add event listeners for controls
    document.getElementById('time-period').addEventListener('change', loadTrendData);
    document.getElementById('trend-metric').addEventListener('change', loadTrendData);
    document.getElementById('agency-sort').addEventListener('change', loadAgencyData);
    document.getElementById('agency-limit').addEventListener('change', loadAgencyData);
    
    // Add event listeners for dataset filters
    document.getElementById('dataset-search').addEventListener('input', function() {
        currentFilters.search = this.value;
        currentPage = 1;
        loadDatasets(1);
    });
    
    document.getElementById('agency-filter').addEventListener('change', function() {
        currentFilters.agency = this.value;
        currentPage = 1;
        loadDatasets(1);
    });
    
    document.getElementById('status-filter').addEventListener('change', function() {
        currentFilters.status = this.value;
        currentPage = 1;
        loadDatasets(1);
    });
    
    document.getElementById('per-page').addEventListener('change', function() {
        currentFilters.perPage = parseInt(this.value);
        currentPage = 1;
        loadDatasets(1);
    });
    
    // Close modal when clicking outside
    document.getElementById('preview-modal').addEventListener('click', function(e) {
        if (e.target === this) {
            closePreviewModal();
        }
    });
    
    // Refresh data every 5 minutes
    setInterval(loadAnalyticsData, 300000);
});
</script>
{% endblock %}

