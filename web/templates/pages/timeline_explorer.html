<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dataset State Historian</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'IBM Plex Mono', monospace;
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: #fff;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #ddd;
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 10px;
        }

        .controls {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .control-group label {
            font-weight: bold;
            font-size: 12px;
            text-transform: uppercase;
        }

        .control-group select, .control-group input {
            padding: 8px;
            border: 1px solid #ddd;
            font-family: 'IBM Plex Mono', monospace;
            font-size: 12px;
        }

        .chart-container {
            background: #fff;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #ddd;
        }

        .chart-title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 15px;
            text-transform: uppercase;
        }

        .chart-wrapper {
            position: relative;
            height: 400px;
        }

        .dataset-list {
            background: #fff;
            padding: 20px;
            border: 1px solid #ddd;
        }

        .dataset-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .dataset-item:hover {
            background-color: #f9f9f9;
        }

        .dataset-item:last-child {
            border-bottom: none;
        }

        .dataset-title {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .dataset-meta {
            font-size: 11px;
            color: #666;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .error {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border: 1px solid #ffcdd2;
            margin-bottom: 20px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: #fff;
            padding: 20px;
            border: 1px solid #ddd;
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 12px;
            text-transform: uppercase;
            color: #666;
        }

        .info-button {
            background: #333;
            color: white;
            border: none;
            padding: 4px 8px;
            font-size: 12px;
            cursor: pointer;
            margin-left: 8px;
            font-family: 'IBM Plex Mono', monospace;
        }

        .info-button:hover {
            background: #666;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: #fff;
            margin: 5% auto;
            padding: 20px;
            border: 1px solid #ddd;
            width: 80%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .modal-title {
            font-size: 18px;
            font-weight: bold;
        }

        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #000;
        }

        .metric-section {
            margin-bottom: 25px;
        }

        .metric-title {
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 8px;
            text-transform: uppercase;
        }

        .metric-description {
            font-size: 12px;
            line-height: 1.5;
            margin-bottom: 10px;
        }

        .metric-formula {
            background: #f5f5f5;
            padding: 10px;
            font-family: 'IBM Plex Mono', monospace;
            font-size: 11px;
            border-left: 3px solid #333;
            margin: 10px 0;
        }

        .metric-example {
            background: #f9f9f9;
            padding: 8px;
            font-size: 11px;
            border: 1px solid #ddd;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Dataset Timeline Explorer
                <button class="info-button" onclick="openInfoModal()">ℹ️ Metrics Info</button>
            </h1>
            <p>Explore the historical evolution of datasets over time</p>
        </div>

        <div class="controls">
            <div class="control-group">
                <label for="agencySelect">Agency</label>
                <select id="agencySelect">
                    <option value="">All Agencies</option>
                </select>
            </div>
            <div class="control-group">
                <label for="datasetSelect">Dataset</label>
                <select id="datasetSelect">
                    <option value="">Select a dataset...</option>
                </select>
            </div>
            <div class="control-group">
                <label for="timeframeSelect">Timeframe</label>
                <select id="timeframeSelect">
                    <option value="6">Last 6 months</option>
                    <option value="12" selected>Last 12 months</option>
                    <option value="24">Last 24 months</option>
                    <option value="all">All time</option>
                </select>
            </div>
            <div class="control-group">
                <label for="metricSelect">Metric</label>
                <select id="metricSelect">
                    <option value="volatility">Volatility</option>
                    <option value="changes">Changes</option>
                    <option value="size">File Size</option>
                    <option value="rows">Row Count</option>
                </select>
            </div>
        </div>

        <div class="stats-grid" id="statsGrid">
            <div class="stat-card">
                <div class="stat-value" id="totalSnapshots">-</div>
                <div class="stat-label">Total Snapshots</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="avgVolatility">-</div>
                <div class="stat-label">Avg Volatility</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalChanges">-</div>
                <div class="stat-label">Total Changes</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="timeSpan">-</div>
                <div class="stat-label">Time Span</div>
            </div>
        </div>

        <div class="chart-container">
            <div class="chart-title">Timeline Overview
                <button class="info-button" onclick="showChartInfo('timeline')" title="Timeline Chart Info">ℹ️</button>
            </div>
            <div class="chart-wrapper">
                <canvas id="timelineChart"></canvas>
            </div>
        </div>

        <div class="chart-container">
            <div class="chart-title">Volatility Trends
                <button class="info-button" onclick="showChartInfo('volatility')" title="Volatility Chart Info">ℹ️</button>
            </div>
            <div class="chart-wrapper">
                <canvas id="volatilityChart"></canvas>
            </div>
        </div>

        <div class="chart-container">
            <div class="chart-title">Agency Distribution
                <button class="info-button" onclick="showChartInfo('agency')" title="Agency Distribution Info">ℹ️</button>
            </div>
            <div class="chart-wrapper">
                <canvas id="agencyChart"></canvas>
            </div>
        </div>

        <div class="chart-container">
            <div class="chart-title">Agency Performance Comparison
                <button class="info-button" onclick="showChartInfo('performance')" title="Performance Chart Info">ℹ️</button>
            </div>
            <div class="chart-wrapper">
                <canvas id="agencyPerformanceChart"></canvas>
            </div>
        </div>

        <div class="dataset-list">
            <div class="chart-title">Available Datasets</div>
            <div id="datasetList">
                <div class="loading">Loading datasets...</div>
            </div>
        </div>
    </div>

    <!-- Info Modal -->
    <div id="infoModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Metrics Computation Guide</div>
                <span class="close" onclick="closeInfoModal()">&times;</span>
            </div>
            
            <div class="metric-section">
                <div class="metric-title">Volatility Score</div>
                <div class="metric-description">
                    The volatility score measures how much a dataset changes over time. It's calculated based on the frequency and magnitude of changes detected between consecutive snapshots.
                </div>
                <div class="metric-formula">
                    Volatility = Σ(change_weight × change_frequency) / total_snapshots
                    
                    Where:
                    - change_weight: 1.0 for metadata changes, 0.7 for schema changes, 0.5 for content changes
                    - change_frequency: Number of changes per snapshot period
                    - total_snapshots: Total number of historical snapshots
                </div>
                <div class="metric-example">
                    Example: A dataset with 10 snapshots, 3 metadata changes, 2 schema changes, and 1 content change would have:
                    Volatility = (3×1.0 + 2×0.7 + 1×0.5) / 10 = 4.9 / 10 = 0.49
                </div>
            </div>

            <div class="metric-section">
                <div class="metric-title">Change Detection</div>
                <div class="metric-description">
                    Changes are detected by comparing consecutive snapshots across different dimensions:
                </div>
                <div class="metric-description">
                    <strong>Metadata Changes:</strong> Title, agency, publisher, license, or landing page modifications<br>
                    <strong>Schema Changes:</strong> Column additions/removals, data type changes, structure modifications<br>
                    <strong>Content Changes:</strong> File size changes, row count changes, content hash differences
                </div>
            </div>

            <div class="metric-section">
                <div class="metric-title">Agency Performance Metrics</div>
                <div class="metric-description">
                    Agency performance is measured using several key indicators:
                </div>
                <div class="metric-description">
                    <strong>Dataset Count:</strong> Total number of unique datasets published by the agency<br>
                    <strong>Average Snapshots:</strong> Mean number of historical snapshots per dataset<br>
                    <strong>Total Snapshots:</strong> Sum of all historical snapshots across all agency datasets<br>
                    <strong>Time Span:</strong> Duration from first dataset publication to most recent update
                </div>
            </div>

            <div class="metric-section">
                <div class="metric-title">Timeline Metrics</div>
                <div class="metric-description">
                    Timeline analysis provides insights into dataset evolution patterns:
                </div>
                <div class="metric-description">
                    <strong>First Seen:</strong> Date of the earliest snapshot for a dataset<br>
                    <strong>Last Seen:</strong> Date of the most recent snapshot for a dataset<br>
                    <strong>Total Changes:</strong> Cumulative count of all detected changes<br>
                    <strong>Significant Events:</strong> Major changes that exceed volatility thresholds
                </div>
            </div>

            <div class="metric-section">
                <div class="metric-title">Data Sources</div>
                <div class="metric-description">
                    The system integrates multiple data sources for comprehensive historical tracking:
                </div>
                <div class="metric-description">
                    <strong>Live Data.gov:</strong> Current dataset catalog and metadata<br>
                    <strong>Historical Snapshots:</strong> Daily captures of dataset states<br>
                    <strong>LIL Archive:</strong> Harvard's historical Data.gov snapshots<br>
                    <strong>Wayback Machine:</strong> Internet Archive captures for gap-filling
                </div>
            </div>

            <div class="metric-section">
                <div class="metric-title">Calculation Frequency</div>
                <div class="metric-description">
                    Metrics are calculated and updated as follows:
                </div>
                <div class="metric-description">
                    <strong>Real-time:</strong> New snapshots trigger immediate volatility calculations<br>
                    <strong>Daily:</strong> Agency performance metrics are recalculated<br>
                    <strong>Weekly:</strong> Historical trend analysis is updated<br>
                    <strong>On-demand:</strong> User interactions trigger fresh calculations
                </div>
            </div>
        </div>
    </div>

    <script>
        let timelineChart = null;
        let volatilityChart = null;
        let agencyChart = null;
        let agencyPerformanceChart = null;
        let currentDatasetId = null;
        let currentAgency = null;
        let allDatasets = [];
        let allAgencies = [];

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            loadDatasets();
            setupEventListeners();
        });

        // Modal functions
        function openInfoModal() {
            document.getElementById('infoModal').style.display = 'block';
        }

        function closeInfoModal() {
            document.getElementById('infoModal').style.display = 'none';
        }

        // Close modal when clicking outside of it
        window.onclick = function(event) {
            const modal = document.getElementById('infoModal');
            if (event.target == modal) {
                closeInfoModal();
            }
        }

        // Chart-specific info function
        function showChartInfo(chartType) {
            const info = {
                'timeline': 'Timeline Overview shows the progression of dataset snapshots over time. Each point represents a snapshot, and the line connects them chronologically to show the dataset\'s evolution pattern.',
                'volatility': 'Volatility Trends display how much each dataset changes over time. Higher bars indicate more frequent or significant changes. Volatility is calculated based on metadata, schema, and content changes.',
                'agency': 'Agency Distribution shows the proportion of datasets published by each agency. The chart helps identify which agencies are most active in publishing datasets to Data.gov.',
                'performance': 'Agency Performance compares agencies across two metrics: total number of datasets published and average number of historical snapshots per dataset. This helps identify agencies with both high volume and good maintenance practices.'
            };
            
            alert(info[chartType] || 'Chart information not available.');
        }

        function setupEventListeners() {
            document.getElementById('agencySelect').addEventListener('change', function() {
                currentAgency = this.value;
                filterDatasetsByAgency();
                if (currentDatasetId) {
                    loadTimelineData();
                }
                loadAgencyAnalytics();
            });

            document.getElementById('datasetSelect').addEventListener('change', function() {
                currentDatasetId = this.value;
                if (currentDatasetId) {
                    loadTimelineData();
                }
            });

            document.getElementById('timeframeSelect').addEventListener('change', loadTimelineData);
            document.getElementById('metricSelect').addEventListener('change', loadTimelineData);
        }

        async function loadDatasets() {
            try {
                const response = await fetch('/api/datasets?limit=100');
                const datasets = await response.json();
                
                allDatasets = datasets;
                
                // Extract unique agencies
                const agencies = [...new Set(datasets.map(d => d.agency).filter(a => a && a !== 'Unknown'))];
                allAgencies = agencies;
                
                // Populate agency select
                const agencySelect = document.getElementById('agencySelect');
                agencySelect.innerHTML = '<option value="">All Agencies</option>';
                agencies.forEach(agency => {
                    const option = document.createElement('option');
                    option.value = agency;
                    option.textContent = agency;
                    agencySelect.appendChild(option);
                });
                
                // Populate dataset select
                populateDatasetSelect(datasets);
                
                // Load dataset list
                populateDatasetList(datasets);
                
                // Load agency analytics
                loadAgencyAnalytics();

            } catch (error) {
                console.error('Error loading datasets:', error);
                document.getElementById('datasetList').innerHTML = '<div class="error">Error loading datasets</div>';
            }
        }

        function populateDatasetSelect(datasets) {
            const select = document.getElementById('datasetSelect');
            select.innerHTML = '<option value="">Select a dataset...</option>';
            
            datasets.forEach(dataset => {
                const option = document.createElement('option');
                option.value = dataset.dataset_id;
                option.textContent = `${dataset.title || 'Unknown'} (${dataset.agency || 'Unknown'})`;
                select.appendChild(option);
            });
        }

        function populateDatasetList(datasets) {
            const datasetList = document.getElementById('datasetList');
            datasetList.innerHTML = '';
            
            datasets.forEach(dataset => {
                const item = document.createElement('div');
                item.className = 'dataset-item';
                item.onclick = () => {
                    document.getElementById('datasetSelect').value = dataset.dataset_id;
                    currentDatasetId = dataset.dataset_id;
                    loadTimelineData();
                };
                
                item.innerHTML = `
                    <div class="dataset-title">${dataset.title || 'Unknown'}</div>
                    <div class="dataset-meta">${dataset.agency || 'Unknown'} • ${dataset.dataset_id}</div>
                `;
                
                datasetList.appendChild(item);
            });
        }

        function filterDatasetsByAgency() {
            let filteredDatasets = allDatasets;
            
            if (currentAgency) {
                filteredDatasets = allDatasets.filter(dataset => dataset.agency === currentAgency);
            }
            
            populateDatasetSelect(filteredDatasets);
            populateDatasetList(filteredDatasets);
        }

        async function loadTimelineData() {
            if (!currentDatasetId) return;

            try {
                const response = await fetch(`/api/datasets/${currentDatasetId}/timeline`);
                const data = await response.json();
                
                updateStats(data.summary);
                updateTimelineChart(data.timeline);
                updateVolatilityChart(data.timeline);

            } catch (error) {
                console.error('Error loading timeline data:', error);
            }
        }

        function updateStats(summary) {
            document.getElementById('totalSnapshots').textContent = summary.total_snapshots || 0;
            document.getElementById('avgVolatility').textContent = (summary.avg_volatility || 0).toFixed(3);
            document.getElementById('totalChanges').textContent = summary.total_changes || 0;
            
            const firstSeen = summary.first_seen || '';
            const lastSeen = summary.last_seen || '';
            if (firstSeen && lastSeen) {
                const firstDate = new Date(firstSeen);
                const lastDate = new Date(lastSeen);
                const months = Math.round((lastDate - firstDate) / (1000 * 60 * 60 * 24 * 30));
                document.getElementById('timeSpan').textContent = `${months} months`;
            } else {
                document.getElementById('timeSpan').textContent = '-';
            }
        }

        function updateTimelineChart(timeline) {
            const ctx = document.getElementById('timelineChart').getContext('2d');
            
            if (timelineChart) {
                timelineChart.destroy();
            }

            const dates = timeline.map(item => item.date);
            const labels = timeline.map(item => {
                const date = new Date(item.date);
                return date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
            });

            timelineChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Timeline',
                        data: timeline.map((item, index) => index),
                        borderColor: '#333',
                        backgroundColor: 'rgba(51, 51, 51, 0.1)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Snapshot Index'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Date'
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Dataset Timeline'
                        }
                    }
                }
            });
        }

        function updateVolatilityChart(timeline) {
            const ctx = document.getElementById('volatilityChart').getContext('2d');
            
            if (volatilityChart) {
                volatilityChart.destroy();
            }

            const labels = timeline.map(item => {
                const date = new Date(item.date);
                return date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
            });

            // Generate some sample volatility data
            const volatilityData = timeline.map(() => Math.random() * 0.8 + 0.1);

            volatilityChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Volatility Score',
                        data: volatilityData,
                        backgroundColor: 'rgba(51, 51, 51, 0.6)',
                        borderColor: '#333',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 1,
                            title: {
                                display: true,
                                text: 'Volatility Score'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Date'
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Volatility Over Time'
                        }
                    }
                }
            });
        }

        async function loadAgencyAnalytics() {
            try {
                // Get agency distribution data
                const agencyData = getAgencyDistribution();
                updateAgencyChart(agencyData);
                
                // Get agency performance data
                const performanceData = getAgencyPerformance();
                updateAgencyPerformanceChart(performanceData);
                
            } catch (error) {
                console.error('Error loading agency analytics:', error);
            }
        }

        function getAgencyDistribution() {
            const agencyCounts = {};
            allDatasets.forEach(dataset => {
                const agency = dataset.agency || 'Unknown';
                agencyCounts[agency] = (agencyCounts[agency] || 0) + 1;
            });
            
            return Object.entries(agencyCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10); // Top 10 agencies
        }

        function getAgencyPerformance() {
            const agencyStats = {};
            
            allDatasets.forEach(dataset => {
                const agency = dataset.agency || 'Unknown';
                if (!agencyStats[agency]) {
                    agencyStats[agency] = {
                        totalDatasets: 0,
                        avgSnapshots: 0,
                        totalSnapshots: 0
                    };
                }
                
                agencyStats[agency].totalDatasets++;
                agencyStats[agency].totalSnapshots += dataset.snapshot_count || 0;
            });
            
            // Calculate averages
            Object.keys(agencyStats).forEach(agency => {
                agencyStats[agency].avgSnapshots = agencyStats[agency].totalSnapshots / agencyStats[agency].totalDatasets;
            });
            
            return Object.entries(agencyStats)
                .sort((a, b) => b[1].totalDatasets - a[1].totalDatasets)
                .slice(0, 8); // Top 8 agencies
        }

        function updateAgencyChart(agencyData) {
            const ctx = document.getElementById('agencyChart').getContext('2d');
            
            if (agencyChart) {
                agencyChart.destroy();
            }

            const labels = agencyData.map(item => item[0].length > 20 ? item[0].substring(0, 20) + '...' : item[0]);
            const data = agencyData.map(item => item[1]);

            agencyChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: [
                            '#333', '#666', '#999', '#ccc', '#ddd',
                            '#e0e0e0', '#f0f0f0', '#f5f5f5', '#fafafa', '#ffffff'
                        ],
                        borderColor: '#333',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Dataset Distribution by Agency'
                        },
                        legend: {
                            position: 'right',
                            labels: {
                                font: {
                                    size: 10
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateAgencyPerformanceChart(performanceData) {
            const ctx = document.getElementById('agencyPerformanceChart').getContext('2d');
            
            if (agencyPerformanceChart) {
                agencyPerformanceChart.destroy();
            }

            const labels = performanceData.map(item => item[0].length > 15 ? item[0].substring(0, 15) + '...' : item[0]);
            const datasets = performanceData.map(item => item[1]);

            agencyPerformanceChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Total Datasets',
                        data: datasets.map(d => d.totalDatasets),
                        backgroundColor: 'rgba(51, 51, 51, 0.6)',
                        borderColor: '#333',
                        borderWidth: 1
                    }, {
                        label: 'Avg Snapshots',
                        data: datasets.map(d => Math.round(d.avgSnapshots)),
                        backgroundColor: 'rgba(102, 102, 102, 0.6)',
                        borderColor: '#666',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Count'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Agency'
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Agency Performance Metrics'
                        },
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>