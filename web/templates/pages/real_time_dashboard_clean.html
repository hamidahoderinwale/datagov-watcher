<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dataset State Historian</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
</head>
<body>
    <header class="header">
        <h1>Real-Time Dataset Monitoring</h1>
        <p>Live monitoring of dataset availability and changes</p>
    </header>
    
    <div class="container">
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="totalDatasets">-</div>
                <div class="stat-label">Total Datasets</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="recentChecks">-</div>
                <div class="stat-label">Recent Checks</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="recentChanges">-</div>
                <div class="stat-label">Recent Changes</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="activeAlerts">-</div>
                <div class="stat-label">Active Alerts</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="avgResponseTime">-</div>
                <div class="stat-label">Avg Response Time</div>
            </div>
        </div>
        
        <div class="text-center mb-20">
            <span class="last-updated">Last updated: Loading...</span>
            <span id="connectionStatus" class="connection-status connecting">Connecting...</span>
        </div>
        
        <div class="controls">
            <div class="control-group">
                <button id="toggleMonitoring" class="btn btn-primary" onclick="toggleMonitoring()">Start Monitoring</button>
                <button class="btn" onclick="refreshData()">Refresh Now</button>
            </div>
            <div class="control-group">
                <label for="refreshInterval">Refresh Interval:</label>
                <select id="refreshInterval" onchange="updateRefreshInterval()">
                    <option value="5000">5 seconds</option>
                    <option value="10000" selected>10 seconds</option>
                    <option value="30000">30 seconds</option>
                    <option value="60000">1 minute</option>
                </select>
            </div>
        </div>
        
        <div class="feed-container">
            <div id="feedContent">
                <div class="loading">Loading real-time data...</div>
            </div>
        </div>
    </div>
    
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
    <script>
        // Real-time specific functionality
        let isMonitoring = false;
        let refreshInterval = null;
        
        function toggleMonitoring() {
            if (isMonitoring) {
                stopMonitoring();
            } else {
                startMonitoring();
            }
        }
        
        function startMonitoring() {
            isMonitoring = true;
            document.getElementById('toggleMonitoring').textContent = 'Stop Monitoring';
            document.getElementById('toggleMonitoring').className = 'btn btn-danger';
            
            const interval = parseInt(document.getElementById('refreshInterval').value);
            refreshInterval = setInterval(refreshData, interval);
            
            updateConnectionStatus('connected', 'Monitoring Active');
        }
        
        function stopMonitoring() {
            isMonitoring = false;
            document.getElementById('toggleMonitoring').textContent = 'Start Monitoring';
            document.getElementById('toggleMonitoring').className = 'btn btn-primary';
            
            if (refreshInterval) {
                clearInterval(refreshInterval);
                refreshInterval = null;
            }
            
            updateConnectionStatus('disconnected', 'Monitoring Stopped');
        }
        
        function updateRefreshInterval() {
            if (isMonitoring) {
                stopMonitoring();
                startMonitoring();
            }
        }
        
        function refreshData() {
            loadDashboardData();
        }
        
        // Override the default loadDashboardData to include real-time specific data
        const originalLoadDashboardData = loadDashboardData;
        loadDashboardData = async function() {
            await originalLoadDashboardData();
            
            // Load additional real-time specific data
            try {
                const healthResponse = await fetch('/api/health');
                const health = await healthResponse.json();
                
                const healthScore = health.health_score || 0;
                document.getElementById('avgResponseTime').textContent = 
                    Math.round(health.avg_response_time || 0) + 'ms';
                
                const healthIndicator = document.getElementById('healthIndicator');
                if (healthIndicator) {
                    if (healthScore >= 80) {
                        healthIndicator.className = 'health-indicator health-excellent';
                    } else if (healthScore >= 60) {
                        healthIndicator.className = 'health-indicator health-good';
                    } else if (healthScore >= 40) {
                        healthIndicator.className = 'health-indicator health-fair';
                    } else {
                        healthIndicator.className = 'health-indicator health-poor';
                    }
                }
                
                updateConnectionStatus('connected', health.monitoring_status || 'Active');
            } catch (error) {
                console.error('Error loading health data:', error);
            }
        };
        
        // Initialize real-time dashboard
        document.addEventListener('DOMContentLoaded', function() {
            loadDashboardData();
        });
    </script>
</body>
</html>
