{% extends "layouts/layout.html" %}

{% block title %}{{ dataset.title or 'Dataset Details' }} - Dataset State Historian{% endblock %}

{% block extra_css %}
<style>
.dataset-detail-container {
    padding: var(--space-6);
    max-width: 1400px;
    margin: 0 auto;
}

.dataset-header {
    margin-bottom: var(--space-8);
    padding-bottom: var(--space-6);
    border-bottom: 2px solid var(--gray-200);
}

.dataset-title {
    font-size: var(--text-3xl);
    font-weight: var(--font-bold);
    color: var(--gray-900);
    margin-bottom: var(--space-3);
    line-height: 1.2;
}

.dataset-agency {
    font-size: var(--text-lg);
    color: var(--primary);
    margin-bottom: var(--space-2);
    font-weight: var(--font-semibold);
}

.dataset-description {
    font-size: var(--text-base);
    color: var(--gray-700);
    line-height: 1.6;
    margin-bottom: var(--space-4);
}

.dataset-meta {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: var(--space-4);
    margin-bottom: var(--space-6);
}

.meta-item {
    background: var(--gray-50);
    padding: var(--space-3);
    border: 1px solid var(--gray-200);
}

.meta-label {
    font-size: var(--text-xs);
    color: var(--gray-600);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: var(--space-1);
}

.meta-value {
    font-size: var(--text-sm);
    color: var(--gray-900);
    font-weight: var(--font-medium);
}

.status-badge {
    display: inline-block;
    padding: var(--space-1) var(--space-2);
    border-radius: 0;
    font-size: var(--text-xs);
    font-weight: var(--font-semibold);
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.status-badge.available {
    background: var(--success-light);
    color: var(--success-dark);
}

.status-badge.unavailable {
    background: var(--error-light);
    color: var(--error-dark);
}

.status-badge.unknown {
    background: var(--gray-200);
    color: var(--gray-700);
}

.content-grid {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: var(--space-6);
    margin-bottom: var(--space-8);
}

.main-content {
    display: flex;
    flex-direction: column;
    gap: var(--space-6);
}

.sidebar {
    display: flex;
    flex-direction: column;
    gap: var(--space-6);
}

.section {
    background: white;
    border: 1px solid var(--gray-200);
    padding: var(--space-6);
}

.section-title {
    font-size: var(--text-xl);
    font-weight: var(--font-semibold);
    color: var(--gray-900);
    margin-bottom: var(--space-4);
    padding-bottom: var(--space-2);
    border-bottom: 1px solid var(--gray-200);
}

.metrics-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: var(--space-4);
    margin-bottom: var(--space-6);
}

.metric-card {
    text-align: center;
    padding: var(--space-4);
    background: var(--gray-50);
    border: 1px solid var(--gray-200);
}

.metric-value {
    font-size: var(--text-2xl);
    font-weight: var(--font-bold);
    color: var(--primary);
    margin-bottom: var(--space-1);
}

.metric-label {
    font-size: var(--text-xs);
    color: var(--gray-600);
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.history-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: var(--space-4);
}

.history-table th,
.history-table td {
    padding: var(--space-3);
    text-align: left;
    border-bottom: 1px solid var(--gray-200);
}

.history-table th {
    background: var(--gray-50);
    font-weight: var(--font-semibold);
    color: var(--gray-700);
    font-size: var(--text-sm);
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.history-table td {
    font-size: var(--text-sm);
    color: var(--gray-900);
}

.changes-list {
    max-height: 400px;
    overflow-y: auto;
}

.change-item {
    padding: var(--space-3);
    border-bottom: 1px solid var(--gray-100);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.change-item:last-child {
    border-bottom: none;
}

.change-content {
    flex: 1;
}

.change-type {
    font-size: var(--text-xs);
    font-weight: var(--font-semibold);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    padding: var(--space-1) var(--space-2);
    border-radius: 0;
    margin-right: var(--space-2);
}

.change-type.content {
    background: var(--info-light);
    color: var(--info-dark);
}

.change-type.schema {
    background: var(--warning-light);
    color: var(--warning-dark);
}

.change-type.metadata {
    background: var(--success-light);
    color: var(--success-dark);
}

.change-type.availability {
    background: var(--error-light);
    color: var(--error-dark);
}

.change-description {
    font-size: var(--text-sm);
    color: var(--gray-700);
    margin-top: var(--space-1);
}

.change-date {
    font-size: var(--text-xs);
    color: var(--gray-500);
}

.quality-score {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    margin-bottom: var(--space-4);
}

.quality-circle {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: var(--font-bold);
    font-size: var(--text-lg);
}

.quality-circle.high {
    background: var(--success-light);
    color: var(--success-dark);
}

.quality-circle.medium {
    background: var(--warning-light);
    color: var(--warning-dark);
}

.quality-circle.low {
    background: var(--error-light);
    color: var(--error-dark);
}

.quality-details {
    flex: 1;
}

.quality-label {
    font-size: var(--text-sm);
    color: var(--gray-600);
    margin-bottom: var(--space-1);
}

.quality-value {
    font-size: var(--text-lg);
    font-weight: var(--font-semibold);
    color: var(--gray-900);
}

.loading {
    text-align: center;
    padding: var(--space-8);
    color: var(--gray-500);
}

.error {
    background: var(--gray-100);
    color: var(--gray-700);
    padding: var(--space-4);
    border: 1px solid var(--gray-300);
    margin: var(--space-4) 0;
    border-radius: 0;
}

.back-button {
    display: inline-flex;
    align-items: center;
    gap: var(--space-2);
    padding: var(--space-2) var(--space-4);
    background: var(--gray-100);
    color: var(--gray-700);
    text-decoration: none;
    border: 1px solid var(--gray-300);
    border-radius: 0;
    font-size: var(--text-sm);
    font-weight: var(--font-medium);
    transition: all var(--transition-fast);
    margin-bottom: var(--space-6);
}

.back-button:hover {
    background: var(--gray-200);
    color: var(--gray-900);
    text-decoration: none;
}

.tags-list {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-2);
    margin-top: var(--space-2);
}

.tag {
    background: var(--primary-light);
    color: var(--primary-dark);
    padding: var(--space-1) var(--space-2);
    border-radius: 0;
    font-size: var(--text-xs);
    font-weight: var(--font-medium);
}

.export-buttons {
    display: flex;
    gap: var(--space-3);
    margin-top: var(--space-4);
}

.export-button {
    padding: var(--space-2) var(--space-4);
    background: var(--gray-100);
    color: var(--gray-700);
    border: 1px solid var(--gray-300);
    border-radius: 0;
    cursor: pointer;
    font-size: var(--text-sm);
    font-weight: var(--font-medium);
    text-decoration: none;
    transition: all var(--transition-fast);
}

.export-button:hover {
    background: var(--gray-200);
    color: var(--gray-900);
    text-decoration: none;
}

.export-button.primary {
    background: var(--primary);
    color: white;
    border-color: var(--primary);
}

.export-button.primary:hover {
    background: var(--primary-dark);
    color: white;
}
</style>
{% endblock %}

{% block content %}
<div class="dataset-detail-container">
    <a href="javascript:history.back()" class="back-button">
        ← BACK
    </a>
    
    <div class="dataset-header">
        <h1 class="dataset-title" id="dataset-title">Loading...</h1>
        <div class="dataset-agency" id="dataset-agency">Loading...</div>
        <div class="dataset-description" id="dataset-description">Loading...</div>
        
        <div class="dataset-meta" id="dataset-meta">
            <div class="meta-item">
                <div class="meta-label">Status</div>
                <div class="meta-value" id="dataset-status">Loading...</div>
            </div>
            <div class="meta-item">
                <div class="meta-label">Last Updated</div>
                <div class="meta-value" id="last-updated">Loading...</div>
            </div>
            <div class="meta-item">
                <div class="meta-label">Format</div>
                <div class="meta-value" id="dataset-format">Loading...</div>
            </div>
            <div class="meta-item">
                <div class="meta-label">File Size</div>
                <div class="meta-value" id="file-size">Loading...</div>
            </div>
        </div>
    </div>

    <div class="content-grid">
        <div class="main-content">
            <!-- Current State -->
            <div class="section">
                <h3 class="section-title">Current State</h3>
                <div class="metrics-grid" id="current-metrics">
                    <div class="metric-card">
                        <div class="metric-value" id="current-rows">-</div>
                        <div class="metric-label">Rows</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="current-columns">-</div>
                        <div class="metric-label">Columns</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="quality-score">-</div>
                        <div class="metric-label">Quality</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="snapshots-count">-</div>
                        <div class="metric-label">Snapshots</div>
                    </div>
                </div>
            </div>

            <!-- History -->
            <div class="section">
                <h3 class="section-title">Historical Data</h3>
                <div id="history-content">
                    <div class="loading">Loading history...</div>
                </div>
            </div>
        </div>

        <div class="sidebar">
            <!-- Quality Metrics -->
            <div class="section">
                <h3 class="section-title">Quality Assessment</h3>
                <div id="quality-content">
                    <div class="loading">Loading quality data...</div>
                </div>
            </div>

            <!-- Recent Changes -->
            <div class="section">
                <h3 class="section-title">Recent Changes</h3>
                <div class="changes-list" id="changes-content">
                    <div class="loading">Loading changes...</div>
                </div>
            </div>

            <!-- Export Options -->
            <div class="section">
                <h3 class="section-title">Export Data</h3>
                <div class="export-buttons">
                    <button class="export-button primary" onclick="exportDataset('csv')">
                        EXPORT CSV
                    </button>
                    <button class="export-button" onclick="exportDataset('json')">
                        EXPORT JSON
                    </button>
                    <button class="export-button" onclick="exportDataset('pdf')">
                        EXPORT PDF
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Get dataset ID from URL
const datasetId = window.location.pathname.split('/').pop();

// Load dataset details
function loadDatasetDetails() {
    fetch(`/api/dataset/${datasetId}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                showError(data.error);
                return;
            }
            
            updateDatasetInfo(data);
            updateCurrentState(data);
            loadHistory(data.history);
            loadQuality(data.quality_metrics);
            loadChanges(data.changes);
        })
        .catch(error => {
            console.error('Error loading dataset details:', error);
            showError('Error loading dataset details');
        });
}

// Update dataset information
function updateDatasetInfo(data) {
    document.getElementById('dataset-title').textContent = data.title;
    document.getElementById('dataset-agency').textContent = data.agency;
    document.getElementById('dataset-description').textContent = data.description || 'No description available';
    
    // Status badge
    const status = data.current_state.availability || 'unknown';
    const statusElement = document.getElementById('dataset-status');
    statusElement.innerHTML = `<span class="status-badge ${status}">${status.toUpperCase()}</span>`;
    
    // Other metadata
    document.getElementById('last-updated').textContent = formatDate(data.current_state.snapshot_date);
    document.getElementById('dataset-format').textContent = data.current_state.resource_format || 'Unknown';
    document.getElementById('file-size').textContent = formatBytes(data.current_state.file_size || 0);
    
    // Tags
    if (data.tags && data.tags.length > 0) {
        const metaContainer = document.getElementById('dataset-meta');
        const tagsItem = document.createElement('div');
        tagsItem.className = 'meta-item';
        tagsItem.innerHTML = `
            <div class="meta-label">Tags</div>
            <div class="tags-list">
                ${data.tags.map(tag => `<span class="tag">${escapeHtml(tag)}</span>`).join('')}
            </div>
        `;
        metaContainer.appendChild(tagsItem);
    }
}

// Update current state metrics
function updateCurrentState(data) {
    const state = data.current_state;
    
    document.getElementById('current-rows').textContent = 
        state.row_count !== null && state.row_count > 0 ? state.row_count.toLocaleString() : 'Computing...';
    document.getElementById('current-columns').textContent = 
        state.column_count !== null && state.column_count > 0 ? state.column_count.toLocaleString() : 'Computing...';
    document.getElementById('quality-score').textContent = 
        data.quality_metrics.analysis_quality_score || 'N/A';
    document.getElementById('snapshots-count').textContent = 
        data.metadata.total_snapshots || '0';
}

// Load history table
function loadHistory(history) {
    const container = document.getElementById('history-content');
    
    if (!history || history.length === 0) {
        container.innerHTML = '<div class="loading">No historical data available</div>';
        return;
    }
    
    container.innerHTML = `
        <table class="history-table">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Rows</th>
                    <th>Columns</th>
                    <th>Size</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                ${history.map(row => `
                    <tr>
                        <td>${formatDate(row.snapshot_date)}</td>
                        <td>${row.row_count !== null && row.row_count > 0 ? row.row_count.toLocaleString() : 'Computing...'}</td>
                        <td>${row.column_count !== null && row.column_count > 0 ? row.column_count.toLocaleString() : 'Computing...'}</td>
                        <td>${formatBytes(row.file_size || 0)}</td>
                        <td>
                            <span class="status-badge ${row.availability || 'unknown'}">
                                ${(row.availability || 'unknown').toUpperCase()}
                            </span>
                        </td>
                    </tr>
                `).join('')}
            </tbody>
        </table>
    `;
}

// Load quality metrics
function loadQuality(quality) {
    const container = document.getElementById('quality-content');
    
    if (!quality || !quality.analysis_quality_score) {
        container.innerHTML = '<div class="loading">No quality data available</div>';
        return;
    }
    
    const score = quality.analysis_quality_score;
    const qualityClass = score >= 80 ? 'high' : score >= 60 ? 'medium' : 'low';
    
    container.innerHTML = `
        <div class="quality-score">
            <div class="quality-circle ${qualityClass}">${score}</div>
            <div class="quality-details">
                <div class="quality-label">Overall Quality Score</div>
                <div class="quality-value">${score}/100</div>
            </div>
        </div>
        <div class="meta-item">
            <div class="meta-label">Content Analyzed</div>
            <div class="meta-value">${quality.content_analyzed ? 'Yes' : 'No'}</div>
        </div>
        <div class="meta-item">
            <div class="meta-label">Schema Columns</div>
            <div class="meta-value">${quality.schema_columns ? quality.schema_columns.length : 0}</div>
        </div>
    `;
}

// Load changes
function loadChanges(changes) {
    const container = document.getElementById('changes-content');
    
    if (!changes || changes.length === 0) {
        container.innerHTML = '<div class="loading">No changes recorded</div>';
        return;
    }
    
    container.innerHTML = changes.map(change => `
        <div class="change-item">
            <div class="change-content">
                <span class="change-type ${change.change_type}">${change.change_type}</span>
                <div class="change-description">${escapeHtml(change.change_description || 'No description')}</div>
            </div>
            <div class="change-date">${formatDate(change.change_date)}</div>
        </div>
    `).join('');
}

// Export dataset
function exportDataset(format) {
    const url = `/api/export/dataset/${datasetId}?format=${format}`;
    window.open(url, '_blank');
}

// Utility functions
function formatDate(dateString) {
    if (!dateString) return 'Unknown';
    return new Date(dateString).toLocaleDateString();
}

function formatBytes(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function showError(message) {
    const container = document.querySelector('.dataset-detail-container');
    container.innerHTML = `
        <div class="error">
            <h3>Error</h3>
            <p>${message}</p>
            <a href="/" class="back-button">← BACK TO DASHBOARD</a>
        </div>
    `;
}

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    loadDatasetDetails();
});
</script>
{% endblock %}