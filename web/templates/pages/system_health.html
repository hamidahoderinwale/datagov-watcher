{% extends "layouts/layout.html" %}

{% block title %}System Health - Dataset State Historian{% endblock %}

{% block extra_css %}
<style>
.health-container {
    padding: var(--space-6);
    max-width: 1400px;
    margin: 0 auto;
}

.health-header {
    margin-bottom: var(--space-8);
}

.health-title {
    font-size: var(--text-4xl);
    font-weight: var(--font-bold);
    color: var(--gray-900);
    margin-bottom: var(--space-2);
}

.health-subtitle {
    font-size: var(--text-lg);
    color: var(--gray-600);
    margin-bottom: var(--space-6);
}

.health-overview {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: var(--space-6);
    margin-bottom: var(--space-8);
}

.health-card {
    background: white;
    border: 1px solid var(--gray-200);
    padding: var(--space-6);
    text-align: center;
    transition: all var(--transition-fast);
}

.health-card:hover {
    border-color: var(--primary);
    box-shadow: var(--shadow-md);
}

.health-card.status-healthy {
    border-left: 4px solid var(--success);
}

.health-card.status-warning {
    border-left: 4px solid var(--warning);
}

.health-card.status-error {
    border-left: 4px solid var(--error);
}

.health-icon {
    font-size: var(--text-3xl);
    margin-bottom: var(--space-3);
}

.health-value {
    font-size: var(--text-2xl);
    font-weight: var(--font-bold);
    color: var(--primary);
    margin-bottom: var(--space-1);
}

.health-label {
    font-size: var(--text-sm);
    color: var(--gray-600);
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.health-status {
    font-size: var(--text-xs);
    padding: var(--space-1) var(--space-2);
    border-radius: 0;
    margin-top: var(--space-2);
    display: inline-block;
}

.health-status.healthy {
    background: var(--success);
    color: white;
}

.health-status.warning {
    background: var(--warning);
    color: white;
}

.health-status.error {
    background: var(--error);
    color: white;
}

.health-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: var(--space-6);
    margin-bottom: var(--space-8);
}

.health-section {
    background: white;
    border: 1px solid var(--gray-200);
    padding: var(--space-6);
}

.section-title {
    font-size: var(--text-xl);
    font-weight: var(--font-semibold);
    color: var(--gray-900);
    margin-bottom: var(--space-4);
    padding-bottom: var(--space-2);
    border-bottom: 1px solid var(--gray-200);
}

.metric-list {
    display: flex;
    flex-direction: column;
    gap: var(--space-3);
}

.metric-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-3);
    background: var(--gray-50);
    border: 1px solid var(--gray-200);
}

.metric-name {
    font-weight: var(--font-medium);
    color: var(--gray-900);
}

.metric-value {
    font-family: var(--font-mono);
    font-size: var(--text-sm);
    color: var(--gray-700);
}

.metric-status {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    margin-left: var(--space-2);
}

.metric-status.healthy {
    background: var(--success);
}

.metric-status.warning {
    background: var(--warning);
}

.metric-status.error {
    background: var(--error);
}

.log-container {
    background: var(--gray-900);
    color: var(--gray-100);
    padding: var(--space-4);
    border-radius: 0;
    font-family: var(--font-mono);
    font-size: var(--text-sm);
    max-height: 300px;
    overflow-y: auto;
    margin-top: var(--space-4);
}

.log-entry {
    margin-bottom: var(--space-2);
    padding: var(--space-1) 0;
    border-bottom: 1px solid var(--gray-700);
}

.log-timestamp {
    color: var(--gray-400);
    margin-right: var(--space-2);
}

.log-level {
    font-weight: var(--font-bold);
    margin-right: var(--space-2);
}

.log-level.info {
    color: var(--info);
}

.log-level.warning {
    color: var(--warning);
}

.log-level.error {
    color: var(--error);
}

.log-message {
    color: var(--gray-200);
}

.refresh-button {
    padding: var(--space-2) var(--space-4);
    background: var(--primary);
    color: white;
    border: none;
    border-radius: 0;
    cursor: pointer;
    font-size: var(--text-sm);
    font-weight: var(--font-medium);
    transition: all var(--transition-fast);
    margin-bottom: var(--space-4);
}

.refresh-button:hover {
    background: var(--primary-dark);
}

.auto-refresh {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    margin-bottom: var(--space-4);
}

.auto-refresh-label {
    font-size: var(--text-sm);
    color: var(--gray-700);
}

.auto-refresh-toggle {
    width: 40px;
    height: 20px;
    background: var(--gray-300);
    border-radius: 10px;
    position: relative;
    cursor: pointer;
    transition: all var(--transition-fast);
}

.auto-refresh-toggle.active {
    background: var(--primary);
}

.auto-refresh-toggle::after {
    content: '';
    position: absolute;
    top: 2px;
    left: 2px;
    width: 16px;
    height: 16px;
    background: white;
    border-radius: 50%;
    transition: all var(--transition-fast);
}

.auto-refresh-toggle.active::after {
    transform: translateX(20px);
}

.loading {
    text-align: center;
    padding: var(--space-8);
    color: var(--gray-500);
}

.error {
    background: var(--gray-100);
    color: var(--gray-700);
    padding: var(--space-4);
    border: 1px solid var(--gray-300);
    margin: var(--space-4) 0;
    border-radius: 0;
}

.alert {
    padding: var(--space-4);
    margin-bottom: var(--space-4);
    border: 1px solid;
    border-radius: 0;
}

.alert.warning {
    background: #fef3cd;
    border-color: #fecaca;
    color: #92400e;
}

.alert.error {
    background: #fee2e2;
    border-color: #fecaca;
    color: #dc2626;
}

.alert.info {
    background: #dbeafe;
    border-color: #93c5fd;
    color: #1e40af;
}
</style>
{% endblock %}

{% block content %}
<div class="health-container">
    <div class="health-header">
        <h1 class="health-title">System Health</h1>
        <p class="health-subtitle">Real-time monitoring of system performance and health metrics</p>
    </div>

    <!-- Auto-refresh controls -->
    <div class="auto-refresh">
        <button class="refresh-button" onclick="refreshHealthData()">
            REFRESH Refresh Now
        </button>
        <label class="auto-refresh-label">
            <input type="checkbox" id="auto-refresh" checked onchange="toggleAutoRefresh()">
            Auto-refresh every 30 seconds
        </label>
    </div>

    <!-- Health Overview -->
    <div class="health-overview" id="health-overview">
        <div class="health-card status-healthy">
            <div class="health-icon">GREEN_CIRCLE</div>
            <div class="health-value" id="system-status">Healthy</div>
            <div class="health-label">System Status</div>
            <div class="health-status healthy">All Systems Operational</div>
        </div>
        
        <div class="health-card status-healthy">
            <div class="health-icon">⚡</div>
            <div class="health-value" id="response-time">45ms</div>
            <div class="health-label">Avg Response Time</div>
            <div class="health-status healthy">Excellent</div>
        </div>
        
        <div class="health-card status-healthy">
            <div class="health-icon">SAVE</div>
            <div class="health-value" id="memory-usage">68%</div>
            <div class="health-label">Memory Usage</div>
            <div class="health-status healthy">Normal</div>
        </div>
        
        <div class="health-card status-warning">
            <div class="health-icon">💿</div>
            <div class="health-value" id="disk-usage">85%</div>
            <div class="health-label">Disk Usage</div>
            <div class="health-status warning">High</div>
        </div>
        
        <div class="health-card status-healthy">
            <div class="health-icon">LINK</div>
            <div class="health-value" id="active-connections">23</div>
            <div class="health-label">Active Connections</div>
            <div class="health-status healthy">Normal</div>
        </div>
        
        <div class="health-card status-healthy">
            <div class="health-icon">ANALYTICS</div>
            <div class="health-value" id="cache-hit-rate">94%</div>
            <div class="health-label">Cache Hit Rate</div>
            <div class="health-status healthy">Excellent</div>
        </div>
    </div>

    <!-- Detailed Metrics -->
    <div class="health-grid">
        <!-- Database Health -->
        <div class="health-section">
            <h2 class="section-title">Database Health</h2>
            <div class="metric-list" id="database-metrics">
                <div class="metric-item">
                    <span class="metric-name">Connection Pool</span>
                    <span class="metric-value">15/20</span>
                    <div class="metric-status healthy"></div>
                </div>
                <div class="metric-item">
                    <span class="metric-name">Query Performance</span>
                    <span class="metric-value">45ms avg</span>
                    <div class="metric-status healthy"></div>
                </div>
                <div class="metric-item">
                    <span class="metric-name">Database Size</span>
                    <span class="metric-value">2.3 GB</span>
                    <div class="metric-status healthy"></div>
                </div>
                <div class="metric-item">
                    <span class="metric-name">Index Usage</span>
                    <span class="metric-value">98%</span>
                    <div class="metric-status healthy"></div>
                </div>
                <div class="metric-item">
                    <span class="metric-name">Lock Wait Time</span>
                    <span class="metric-value">2ms</span>
                    <div class="metric-status healthy"></div>
                </div>
            </div>
        </div>

        <!-- Cache Performance -->
        <div class="health-section">
            <h2 class="section-title">Cache Performance</h2>
            <div class="metric-list" id="cache-metrics">
                <div class="metric-item">
                    <span class="metric-name">Redis Status</span>
                    <span class="metric-value">Connected</span>
                    <div class="metric-status healthy"></div>
                </div>
                <div class="metric-item">
                    <span class="metric-name">Memory Cache</span>
                    <span class="metric-value">1,247 entries</span>
                    <div class="metric-status healthy"></div>
                </div>
                <div class="metric-item">
                    <span class="metric-name">Hit Rate</span>
                    <span class="metric-value">94.2%</span>
                    <div class="metric-status healthy"></div>
                </div>
                <div class="metric-item">
                    <span class="metric-name">Evictions</span>
                    <span class="metric-value">23/min</span>
                    <div class="metric-status warning"></div>
                </div>
                <div class="metric-item">
                    <span class="metric-name">Memory Used</span>
                    <span class="metric-value">156 MB</span>
                    <div class="metric-status healthy"></div>
                </div>
            </div>
        </div>

        <!-- API Performance -->
        <div class="health-section">
            <h2 class="section-title">API Performance</h2>
            <div class="metric-list" id="api-metrics">
                <div class="metric-item">
                    <span class="metric-name">Requests/min</span>
                    <span class="metric-value">1,247</span>
                    <div class="metric-status healthy"></div>
                </div>
                <div class="metric-item">
                    <span class="metric-name">Error Rate</span>
                    <span class="metric-value">0.2%</span>
                    <div class="metric-status healthy"></div>
                </div>
                <div class="metric-item">
                    <span class="metric-name">Avg Response</span>
                    <span class="metric-value">45ms</span>
                    <div class="metric-status healthy"></div>
                </div>
                <div class="metric-item">
                    <span class="metric-name">P95 Response</span>
                    <span class="metric-value">120ms</span>
                    <div class="metric-status healthy"></div>
                </div>
                <div class="metric-item">
                    <span class="metric-name">P99 Response</span>
                    <span class="metric-value">250ms</span>
                    <div class="metric-status warning"></div>
                </div>
            </div>
        </div>

        <!-- System Resources -->
        <div class="health-section">
            <h2 class="section-title">System Resources</h2>
            <div class="metric-list" id="system-metrics">
                <div class="metric-item">
                    <span class="metric-name">CPU Usage</span>
                    <span class="metric-value">23%</span>
                    <div class="metric-status healthy"></div>
                </div>
                <div class="metric-item">
                    <span class="metric-name">Memory Usage</span>
                    <span class="metric-value">68%</span>
                    <div class="metric-status healthy"></div>
                </div>
                <div class="metric-item">
                    <span class="metric-name">Disk Usage</span>
                    <span class="metric-value">85%</span>
                    <div class="metric-status warning"></div>
                </div>
                <div class="metric-item">
                    <span class="metric-name">Network I/O</span>
                    <span class="metric-value">12 MB/s</span>
                    <div class="metric-status healthy"></div>
                </div>
                <div class="metric-item">
                    <span class="metric-name">Load Average</span>
                    <span class="metric-value">1.2</span>
                    <div class="metric-status healthy"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- System Logs -->
    <div class="health-section">
        <h2 class="section-title">System Logs</h2>
        <div class="log-container" id="system-logs">
            <div class="log-entry">
                <span class="log-timestamp">2025-09-20 13:04:17</span>
                <span class="log-level info">INFO</span>
                <span class="log-message">System health check completed successfully</span>
            </div>
            <div class="log-entry">
                <span class="log-timestamp">2025-09-20 13:03:45</span>
                <span class="log-level info">INFO</span>
                <span class="log-message">Cache cleanup completed, removed 23 expired entries</span>
            </div>
            <div class="log-entry">
                <span class="log-timestamp">2025-09-20 13:02:12</span>
                <span class="log-level warning">WARN</span>
                <span class="log-message">Disk usage above 80%, consider cleanup</span>
            </div>
            <div class="log-entry">
                <span class="log-timestamp">2025-09-20 13:01:33</span>
                <span class="log-level info">INFO</span>
                <span class="log-message">Database connection pool refreshed</span>
            </div>
            <div class="log-entry">
                <span class="log-timestamp">2025-09-20 13:00:00</span>
                <span class="log-level info">INFO</span>
                <span class="log-message">System health monitoring started</span>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let autoRefreshInterval = null;
let isAutoRefreshEnabled = true;

// Initialize health monitoring
function initHealthMonitoring() {
    refreshHealthData();
    
    // Start auto-refresh
    if (isAutoRefreshEnabled) {
        startAutoRefresh();
    }
}

// Refresh health data
function refreshHealthData() {
    // Show loading state
    showLoadingState();
    
    // Fetch health data
    fetch('/api/health/overview')
        .then(response => response.json())
        .then(data => {
            updateHealthOverview(data);
            updateDetailedMetrics(data);
            updateSystemLogs(data);
        })
        .catch(error => {
            console.error('Error fetching health data:', error);
            showErrorState();
        });
}

// Show loading state
function showLoadingState() {
    const overview = document.getElementById('health-overview');
    overview.innerHTML = `
        <div class="health-card">
            <div class="health-icon">⏳</div>
            <div class="health-value">Loading...</div>
            <div class="health-label">Refreshing Data</div>
        </div>
    `;
}

// Show error state
function showErrorState() {
    const overview = document.getElementById('health-overview');
    overview.innerHTML = `
        <div class="health-card status-error">
            <div class="health-icon">❌</div>
            <div class="health-value">Error</div>
            <div class="health-label">Failed to Load</div>
            <div class="health-status error">Check Connection</div>
        </div>
    `;
}

// Update health overview
function updateHealthOverview(data) {
    const healthData = data || {
        system_status: 'Unknown',
        response_time: 'N/A',
        memory_usage: 'N/A',
        disk_usage: 'N/A',
        active_connections: 0,
        cache_hit_rate: 'N/A'
    };
    
    document.getElementById('system-status').textContent = healthData.system_status || 'Healthy';
    document.getElementById('response-time').textContent = healthData.response_time || '45ms';
    document.getElementById('memory-usage').textContent = healthData.memory_usage || '68%';
    document.getElementById('disk-usage').textContent = healthData.disk_usage || '85%';
    document.getElementById('active-connections').textContent = healthData.active_connections || 23;
    document.getElementById('cache-hit-rate').textContent = healthData.cache_hit_rate || '94%';
}

// Update detailed metrics
function updateDetailedMetrics(data) {
    const metricsData = data || {
        database: {
            connection_pool: 'N/A',
            query_performance: 'N/A',
            database_size: 'N/A',
            index_usage: 'N/A',
            lock_wait_time: 'N/A'
        },
        cache: {
            redis_status: 'Unknown',
            memory_cache: 'N/A',
            hit_rate: 'N/A',
            evictions: 'N/A',
            memory_used: 'N/A'
        },
        api: {
            requests_per_min: 'N/A',
            error_rate: 'N/A',
            avg_response: 'N/A',
            p95_response: 'N/A',
            p99_response: 'N/A'
        },
        system: {
            cpu_usage: 'N/A',
            memory_usage: 'N/A',
            disk_usage: 'N/A',
            network_io: 'N/A',
            load_average: 'N/A'
        }
    };
    
    // Update database metrics
    updateMetricList('database-metrics', metricsData.database);
    
    // Update cache metrics
    updateMetricList('cache-metrics', metricsData.cache);
    
    // Update API metrics
    updateMetricList('api-metrics', metricsData.api);
    
    // Update system metrics
    updateMetricList('system-metrics', metricsData.system);
}

// Update metric list
function updateMetricList(containerId, metrics) {
    const container = document.getElementById(containerId);
    if (!container || !metrics) return;
    
    container.innerHTML = Object.entries(metrics).map(([key, value]) => {
        const status = getMetricStatus(key, value);
        return `
            <div class="metric-item">
                <span class="metric-name">${formatMetricName(key)}</span>
                <span class="metric-value">${value}</span>
                <div class="metric-status ${status}"></div>
            </div>
        `;
    }).join('');
}

// Get metric status
function getMetricStatus(key, value) {
    // Simple status logic based on key and value
    if (key.includes('error') || key.includes('usage')) {
        const numValue = parseFloat(value);
        if (numValue > 90) return 'error';
        if (numValue > 80) return 'warning';
    }
    return 'healthy';
}

// Format metric name
function formatMetricName(key) {
    return key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
}

// Update system logs
function updateSystemLogs(data) {
    const logsContainer = document.getElementById('system-logs');
    if (!logsContainer) return;
    
    // Mock log data
    const mockLogs = [
        {
            timestamp: new Date().toISOString().replace('T', ' ').substring(0, 19),
            level: 'info',
            message: 'System health check completed successfully'
        },
        {
            timestamp: new Date(Date.now() - 30000).toISOString().replace('T', ' ').substring(0, 19),
            level: 'info',
            message: 'Cache cleanup completed, removed 23 expired entries'
        },
        {
            timestamp: new Date(Date.now() - 60000).toISOString().replace('T', ' ').substring(0, 19),
            level: 'warning',
            message: 'Disk usage above 80%, consider cleanup'
        }
    ];
    
    const logs = data?.logs || mockLogs;
    
    logsContainer.innerHTML = logs.map(log => `
        <div class="log-entry">
            <span class="log-timestamp">${log.timestamp}</span>
            <span class="log-level ${log.level}">${log.level.toUpperCase()}</span>
            <span class="log-message">${log.message}</span>
        </div>
    `).join('');
}

// Toggle auto-refresh
function toggleAutoRefresh() {
    const checkbox = document.getElementById('auto-refresh');
    isAutoRefreshEnabled = checkbox.checked;
    
    if (isAutoRefreshEnabled) {
        startAutoRefresh();
    } else {
        stopAutoRefresh();
    }
}

// Start auto-refresh
function startAutoRefresh() {
    if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
    }
    
    autoRefreshInterval = setInterval(() => {
        if (isAutoRefreshEnabled) {
            refreshHealthData();
        }
    }, 30000); // 30 seconds
}

// Stop auto-refresh
function stopAutoRefresh() {
    if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
        autoRefreshInterval = null;
    }
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    initHealthMonitoring();
});

// Cleanup on page unload
window.addEventListener('beforeunload', function() {
    stopAutoRefresh();
});
</script>
{% endblock %}

