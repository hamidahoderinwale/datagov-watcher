{% extends "layouts/layout.html" %}

{% block title %}Post-mortem Reports - Dataset State Historian{% endblock %}

{% block extra_css %}
<style>
.postmortem-container {
    padding: var(--space-6);
    max-width: 1400px;
    margin: 0 auto;
}

.postmortem-header {
    margin-bottom: var(--space-6);
}

.postmortem-title {
    font-size: var(--text-3xl);
    font-weight: var(--font-bold);
    color: var(--gray-900);
    margin-bottom: var(--space-2);
}

.postmortem-subtitle {
    font-size: var(--text-lg);
    color: var(--gray-600);
    margin-bottom: var(--space-4);
}

.vanished-summary {
    display: flex;
    gap: var(--space-6);
    margin-top: var(--space-4);
    padding: var(--space-4);
    background: #fef2f2;
    border: 1px solid #fecaca;
    border-radius: 8px;
}

.summary-stat {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
}

.stat-value {
    font-size: var(--text-2xl);
    font-weight: var(--font-bold);
    color: #dc2626;
    margin-bottom: var(--space-1);
}

.stat-label {
    font-size: var(--text-sm);
    color: var(--gray-600);
    font-weight: var(--font-medium);
}

.political-analysis-section {
    background: white;
    border: 1px solid var(--gray-200);
    border-radius: 8px;
    padding: var(--space-6);
    margin-bottom: var(--space-6);
}

.political-analysis-section h3 {
    font-size: var(--text-xl);
    font-weight: var(--font-bold);
    color: var(--gray-900);
    margin-bottom: var(--space-2);
}

.analysis-subtitle {
    font-size: var(--text-sm);
    color: var(--gray-600);
    margin-bottom: var(--space-2);
    font-style: italic;
}

.research-note {
    background: #fef3c7;
    border: 1px solid #f59e0b;
    border-radius: 6px;
    padding: var(--space-3);
    margin-bottom: var(--space-4);
}

.research-note p {
    margin: 0;
    font-size: var(--text-sm);
    color: #92400e;
    line-height: 1.5;
}

.analysis-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--space-6);
}

.analysis-card {
    background: #f9fafb;
    border: 1px solid var(--gray-200);
    border-radius: 6px;
    padding: var(--space-4);
}

.analysis-card h4 {
    font-size: var(--text-lg);
    font-weight: var(--font-semibold);
    color: var(--gray-800);
    margin-bottom: var(--space-3);
}

.timeline-stats {
    display: flex;
    flex-direction: column;
    gap: var(--space-2);
}

.timeline-stat {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-2);
    background: white;
    border-radius: 4px;
    border: 1px solid var(--gray-200);
}

.affected-agencies-list {
    list-style: none;
    padding: 0;
    margin: var(--space-3) 0 0 0;
}

.affected-agencies-list li {
    padding: var(--space-1) 0;
    color: var(--gray-700);
    border-bottom: 1px solid var(--gray-100);
}

.affected-agencies-list li:last-child {
    border-bottom: none;
}

.vanished-datasets-list {
    background: white;
    border: 1px solid var(--gray-200);
    margin-bottom: var(--space-6);
}

.vanished-dataset-item {
    padding: var(--space-4);
    border-bottom: 1px solid var(--gray-100);
    cursor: pointer;
    transition: background-color var(--transition-fast);
    border-left: 4px solid #dc2626;
    background: #fef2f2;
}

.vanished-dataset-item:hover {
    background-color: #fee2e2;
    border-left-color: #b91c1c;
}

.vanished-dataset-item:last-child {
    border-bottom: none;
}

.dataset-title {
    font-size: var(--text-lg);
    font-weight: var(--font-semibold);
    color: var(--gray-900);
    margin-bottom: var(--space-2);
}

.dataset-meta {
    display: flex;
    gap: var(--space-4);
    font-size: var(--text-sm);
    color: var(--gray-600);
    margin-bottom: var(--space-2);
}

.vanished-status {
    display: inline-flex;
    align-items: center;
    gap: var(--space-1);
    padding: 4px 8px;
    background-color: #fee2e2;
    color: #dc2626;
    border-radius: 4px;
    font-size: var(--text-xs);
    font-weight: var(--font-medium);
    border: 1px solid #fecaca;
    text-transform: uppercase;
}

.postmortem-report {
    background: white;
    border: 1px solid var(--gray-200);
    margin-bottom: var(--space-6);
    display: none;
}

.report-header {
    padding: var(--space-6);
    border-bottom: 1px solid var(--gray-200);
    background: var(--gray-50);
}

.report-title {
    font-size: var(--text-2xl);
    font-weight: var(--font-bold);
    color: var(--gray-900);
    margin-bottom: var(--space-2);
}

.report-subtitle {
    font-size: var(--text-lg);
    color: var(--gray-600);
    margin-bottom: var(--space-4);
}

.report-meta {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: var(--space-4);
}

.meta-item {
    display: flex;
    flex-direction: column;
    gap: var(--space-1);
}

.meta-label {
    font-size: var(--text-xs);
    font-weight: var(--font-medium);
    color: var(--gray-500);
    text-transform: uppercase;
}

.meta-value {
    font-size: var(--text-sm);
    color: var(--gray-700);
    font-family: var(--font-mono);
}

.report-sections {
    padding: var(--space-6);
}

.report-section {
    margin-bottom: var(--space-8);
}

.section-title {
    font-size: var(--text-xl);
    font-weight: var(--font-semibold);
    color: var(--gray-900);
    margin-bottom: var(--space-4);
    padding-bottom: var(--space-2);
    border-bottom: 2px solid var(--gray-200);
}

.timeline-events {
    background: var(--gray-50);
    border: 1px solid var(--gray-200);
    padding: var(--space-4);
}

.timeline-event {
    display: flex;
    align-items: center;
    gap: var(--space-3);
    padding: var(--space-3);
    border-bottom: 1px solid var(--gray-200);
}

.timeline-event:last-child {
    border-bottom: none;
}

.event-date {
    font-size: var(--text-sm);
    color: var(--gray-500);
    font-family: var(--font-mono);
    min-width: 120px;
}

.event-description {
    flex: 1;
    font-size: var(--text-sm);
    color: var(--gray-700);
}

.event-severity {
    padding: var(--space-1) var(--space-2);
    border-radius: 0;
    font-size: var(--text-xs);
    font-weight: var(--font-medium);
    text-transform: uppercase;
}

.severity-critical {
    background-color: #ffebee;
    color: #c62828;
}

.severity-high {
    background-color: #fff3e0;
    color: #ef6c00;
}

.severity-medium {
    background-color: #fff8e1;
    color: #f57f17;
}

.cause-analysis {
    background: #f8f9fa;
    border: 1px solid var(--gray-200);
    padding: var(--space-4);
    margin: var(--space-4) 0;
}

.cause-item {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    margin-bottom: var(--space-2);
}

.cause-probability {
    font-size: var(--text-sm);
    font-weight: var(--font-medium);
    color: var(--gray-700);
    min-width: 80px;
}

.cause-description {
    flex: 1;
    font-size: var(--text-sm);
    color: var(--gray-600);
}

.recommendations {
    background: #e8f5e8;
    border: 1px solid #c8e6c9;
    padding: var(--space-4);
    margin: var(--space-4) 0;
}

.recommendation-item {
    display: flex;
    align-items: flex-start;
    gap: var(--space-2);
    margin-bottom: var(--space-2);
}

.recommendation-priority {
    font-size: var(--text-sm);
    font-weight: var(--font-medium);
    color: var(--gray-700);
    min-width: 80px;
}

.recommendation-text {
    flex: 1;
    font-size: var(--text-sm);
    color: var(--gray-700);
}

.export-controls {
    display: flex;
    gap: var(--space-2);
    margin-bottom: var(--space-4);
}

.export-button {
    padding: var(--space-2) var(--space-4);
    background-color: var(--primary);
    color: white;
    border: none;
    border-radius: 0;
    font-size: var(--text-sm);
    font-family: var(--font-family);
    cursor: pointer;
    transition: background-color var(--transition-fast);
}

.export-button:hover {
    background-color: var(--primary-dark);
}

.loading {
    text-align: center;
    padding: var(--space-8);
    color: var(--gray-500);
}

.error {
    background: var(--gray-100);
    color: var(--error);
    padding: var(--space-4);
    border: 1px solid var(--gray-200);
    border-radius: 0;
    margin: var(--space-4) 0;
}

.no-data {
    text-align: center;
    padding: var(--space-8);
    color: var(--gray-500);
    font-style: italic;
}

@media (max-width: 768px) {
    .report-meta {
        grid-template-columns: 1fr;
    }
    
    .timeline-event {
        flex-direction: column;
        align-items: flex-start;
    }
    
    .event-date {
        min-width: auto;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="postmortem-container">
    <div class="postmortem-header">
        <h1 class="postmortem-title">Post-mortem Reports</h1>
        <p class="postmortem-subtitle">Analysis of vanished datasets and suspected causes</p>
        <div class="vanished-summary" id="vanished-summary">
            <div class="summary-stat">
                <span class="stat-value" id="total-vanished">-</span>
                <span class="stat-label">Total Vanished Datasets</span>
            </div>
            <div class="summary-stat">
                <span class="stat-value" id="climate-related">-</span>
                <span class="stat-label">Climate Related</span>
            </div>
            <div class="summary-stat">
                <span class="stat-value" id="dei-related">-</span>
                <span class="stat-label">DEI Related</span>
            </div>
            <div class="summary-stat">
                <span class="stat-value" id="affected-agencies">-</span>
                <span class="stat-label">From Affected Agencies</span>
            </div>
        </div>
    </div>

    <div class="export-controls">
        <button id="refresh-reports" class="export-button">Refresh Reports</button>
        <button id="export-all-pdf" class="export-button">Export All PDF</button>
    </div>

    <div class="vanished-datasets-list" id="vanished-datasets-list">
        <div class="loading">Loading vanished datasets...</div>
    </div>

    <!-- Political Analysis Section -->
    <div class="political-analysis-section" id="political-analysis-section">
        <h3>Political Analysis</h3>
        <p class="analysis-subtitle">Analysis of political patterns in dataset disappearances based on 404 Media research</p>
        <div class="research-note">
            <p><strong>Research Source:</strong> 404 Media reported that over 2,000 datasets have disappeared from Data.gov since Trump's inauguration, with disproportionate impact on climate and environmental data from agencies like DOE, NOAA, DOI, NASA, and EPA.</p>
        </div>
        
        <div class="analysis-grid">
            <div class="analysis-card">
                <h4>Timeline Analysis</h4>
                <div class="timeline-stats" id="timeline-stats">
                    <div class="timeline-stat">
                        <span class="stat-label">Post-Trump 2017 Inauguration</span>
                        <span class="stat-value" id="post-trump-2017">-</span>
                    </div>
                    <div class="timeline-stat">
                        <span class="stat-label">Post-Biden Inauguration</span>
                        <span class="stat-value" id="post-biden">-</span>
                    </div>
                    <div class="timeline-stat">
                        <span class="stat-label">Post-Trump 2025 Inauguration</span>
                        <span class="stat-value" id="post-trump-2025">-</span>
                    </div>
                </div>
            </div>
            
            <div class="analysis-card">
                <h4>Affected Agencies</h4>
                <div class="agency-stats" id="agency-stats">
                    <p>Based on 404 Media research, these agencies are disproportionately affected:</p>
                    <ul class="affected-agencies-list">
                        <li>Department of Energy</li>
                        <li>National Oceanic and Atmospheric Administration</li>
                        <li>Department of the Interior</li>
                        <li>NASA</li>
                        <li>Environmental Protection Agency</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <div class="postmortem-report" id="postmortem-report">
        <div class="report-header">
            <h2 class="report-title" id="report-title">Post-mortem Report</h2>
            <p class="report-subtitle" id="report-subtitle">Dataset Analysis</p>
            
            <div class="report-meta" id="report-meta">
                <!-- Meta information will be populated here -->
            </div>
        </div>
        
        <div class="report-sections" id="report-sections">
            <!-- Report sections will be populated here -->
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
class PostmortemReports {
    constructor() {
        this.vanishedDatasets = [];
        this.currentReport = null;
        this.init();
    }

    init() {
        this.loadVanishedDatasets();
        this.loadPoliticalAnalysis();
        this.bindEvents();
    }

    async loadVanishedDatasets() {
        try {
            const response = await fetch('/api/vanished-datasets');
            const data = await response.json();
            
            this.vanishedDatasets = data.vanished_datasets || [];
            this.renderVanishedDatasets();
            this.updateSummary(data.count || this.vanishedDatasets.length);
        } catch (error) {
            console.error('Error loading vanished datasets:', error);
            this.showError('Error loading vanished datasets');
        }
    }

    updateSummary(count) {
        const totalVanishedEl = document.getElementById('total-vanished');
        if (totalVanishedEl) {
            totalVanishedEl.textContent = count;
        }
    }

    async loadPoliticalAnalysis() {
        try {
            const response = await fetch('/api/vanished-datasets/political-analysis');
            const data = await response.json();
            
            this.updatePoliticalAnalysis(data);
        } catch (error) {
            console.error('Error loading political analysis:', error);
        }
    }

    updatePoliticalAnalysis(analysis) {
        // Update summary stats
        const climateRelatedEl = document.getElementById('climate-related');
        const deiRelatedEl = document.getElementById('dei-related');
        const affectedAgenciesEl = document.getElementById('affected-agencies');
        
        if (climateRelatedEl) {
            climateRelatedEl.textContent = analysis.content_analysis?.climate_related || 0;
        }
        if (deiRelatedEl) {
            deiRelatedEl.textContent = analysis.content_analysis?.dei_related || 0;
        }
        if (affectedAgenciesEl) {
            affectedAgenciesEl.textContent = analysis.political_patterns?.affected_agencies_count || 0;
        }
        
        // Update timeline stats
        const postTrump2017El = document.getElementById('post-trump-2017');
        const postBidenEl = document.getElementById('post-biden');
        const postTrump2025El = document.getElementById('post-trump-2025');
        
        if (postTrump2017El) {
            postTrump2017El.textContent = analysis.political_patterns?.post_trump_2017_inauguration || 0;
        }
        if (postBidenEl) {
            postBidenEl.textContent = analysis.political_patterns?.post_biden_inauguration || 0;
        }
        if (postTrump2025El) {
            postTrump2025El.textContent = analysis.political_patterns?.post_trump_2025_inauguration || 0;
        }
    }

    bindEvents() {
        document.getElementById('refresh-reports').addEventListener('click', () => {
            this.loadVanishedDatasets();
            this.loadPoliticalAnalysis();
        });

        document.getElementById('export-all-pdf').addEventListener('click', () => {
            this.exportAllReports();
        });
    }

    renderVanishedDatasets() {
        const list = document.getElementById('vanished-datasets-list');
        
        if (this.vanishedDatasets.length === 0) {
            list.innerHTML = '<div class="no-data">No vanished datasets found</div>';
            return;
        }
        
        list.innerHTML = this.vanishedDatasets.map(dataset => {
            const daysMissing = this.calculateDaysMissing(dataset.last_seen_date);
            return `
                <div class="vanished-dataset-item" onclick="postmortemReports.loadReport('${dataset.dataset_id}')">
                    <div class="dataset-title">${this.escapeHtml(dataset.title || 'Unknown Dataset')}</div>
                    <div class="dataset-meta">
                        <span><strong>Agency:</strong> ${this.escapeHtml(dataset.agency || 'Unknown')}</span>
                        <span><strong>Last Seen:</strong> ${this.formatDate(dataset.last_seen_date)}</span>
                        <span><strong>Days Missing:</strong> ${daysMissing}</span>
                        <span><strong>Status:</strong> ${this.escapeHtml(dataset.status || 'Unknown')}</span>
                    </div>
                    <div class="vanished-status">${this.escapeHtml(dataset.status || 'Vanished')}</div>
                </div>
            `;
        }).join('');
    }

    async loadReport(datasetId) {
        try {
            const response = await fetch(`/api/dataset/${datasetId}/postmortem`);
            const data = await response.json();
            
            this.currentReport = data;
            this.renderReport();
            document.getElementById('postmortem-report').style.display = 'block';
        } catch (error) {
            console.error('Error loading postmortem report:', error);
            this.showError('Error loading postmortem report');
        }
    }

    renderReport() {
        if (!this.currentReport) return;
        
        const report = this.currentReport;
        
        // Update header
        document.getElementById('report-title').textContent = `Post-mortem Report: ${report.dataset_title || 'Unknown Dataset'}`;
        document.getElementById('report-subtitle').textContent = `Analysis of dataset disappearance`;
        
        // Update meta information
        const meta = document.getElementById('report-meta');
        meta.innerHTML = `
            <div class="meta-item">
                <div class="meta-label">Dataset ID</div>
                <div class="meta-value">${report.dataset_id}</div>
            </div>
            <div class="meta-item">
                <div class="meta-label">Agency</div>
                <div class="meta-value">${report.agency || 'Unknown'}</div>
            </div>
            <div class="meta-item">
                <div class="meta-label">Last Seen</div>
                <div class="meta-value">${this.formatDate(report.last_seen_date)}</div>
            </div>
            <div class="meta-item">
                <div class="meta-label">Days Missing</div>
                <div class="meta-value">${report.days_missing || 'Unknown'}</div>
            </div>
            <div class="meta-item">
                <div class="meta-label">Status</div>
                <div class="meta-value">Vanished</div>
            </div>
        `;
        
        // Render report sections
        this.renderTimelineSection(report);
        this.renderCauseAnalysisSection(report);
        this.renderRecommendationsSection(report);
    }

    renderTimelineSection(report) {
        const sections = document.getElementById('report-sections');
        
        const timelineHtml = `
            <div class="report-section">
                <h3 class="section-title">Timeline of Events</h3>
                <div class="timeline-events">
                    ${(report.timeline_events || []).map(event => `
                        <div class="timeline-event">
                            <div class="event-date">${this.formatDate(event.date)}</div>
                            <div class="event-description">${this.escapeHtml(event.description)}</div>
                            <div class="event-severity severity-${event.severity}">${event.severity}</div>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
        
        sections.innerHTML = timelineHtml;
    }

    renderCauseAnalysisSection(report) {
        const sections = document.getElementById('report-sections');
        
        const causeAnalysisHtml = `
            <div class="report-section">
                <h3 class="section-title">Cause Analysis</h3>
                <div class="cause-analysis">
                    <p><strong>Suspected Causes (in order of probability):</strong></p>
                    ${(report.suspected_causes || []).map(cause => `
                        <div class="cause-item">
                            <div class="cause-probability">${cause.probability}%</div>
                            <div class="cause-description">${this.escapeHtml(cause.description)}</div>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
        
        sections.innerHTML += causeAnalysisHtml;
    }

    renderRecommendationsSection(report) {
        const sections = document.getElementById('report-sections');
        
        const recommendationsHtml = `
            <div class="report-section">
                <h3 class="section-title">Recommendations</h3>
                <div class="recommendations">
                    <p><strong>Recommended Actions:</strong></p>
                    ${(report.recommendations || []).map(rec => `
                        <div class="recommendation-item">
                            <div class="recommendation-priority">${rec.priority}</div>
                            <div class="recommendation-text">${this.escapeHtml(rec.text)}</div>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
        
        sections.innerHTML += recommendationsHtml;
    }

    exportAllReports() {
        if (this.vanishedDatasets.length === 0) {
            alert('No reports to export');
            return;
        }
        
        // For now, just export the current report if available
        if (this.currentReport) {
            this.exportReport(this.currentReport);
        } else {
            alert('Please select a dataset to export its report');
        }
    }

    exportReport(report) {
        const content = this.generateReportContent(report);
        const blob = new Blob([content], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `postmortem_${report.dataset_id}.txt`;
        a.click();
        URL.revokeObjectURL(url);
    }

    generateReportContent(report) {
        return `
POST-MORTEM REPORT
==================

Dataset: ${report.dataset_title || 'Unknown'}
Agency: ${report.agency || 'Unknown'}
Dataset ID: ${report.dataset_id}
Last Seen: ${this.formatDate(report.last_seen_date)}
Days Missing: ${report.days_missing || 'Unknown'}

TIMELINE OF EVENTS
==================
${(report.timeline_events || []).map(event => 
    `${this.formatDate(event.date)} - ${event.description} (${event.severity})`
).join('\n')}

CAUSE ANALYSIS
==============
${(report.suspected_causes || []).map(cause => 
    `${cause.probability}% - ${cause.description}`
).join('\n')}

RECOMMENDATIONS
===============
${(report.recommendations || []).map(rec => 
    `${rec.priority} - ${rec.text}`
).join('\n')}

Generated: ${new Date().toISOString()}
        `.trim();
    }

    formatDate(dateString) {
        return new Date(dateString).toLocaleDateString();
    }

    calculateDaysMissing(lastSeenDate) {
        if (!lastSeenDate) return 'Unknown';
        const lastSeen = new Date(lastSeenDate);
        const now = new Date();
        const diffTime = Math.abs(now - lastSeen);
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        return diffDays;
    }

    escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    showError(message) {
        const list = document.getElementById('vanished-datasets-list');
        list.innerHTML = `<div class="error">${message}</div>`;
    }
}

// Initialize when page loads
const postmortemReports = new PostmortemReports();
</script>
{% endblock %}
