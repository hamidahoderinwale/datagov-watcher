{% extends "layouts/layout.html" %}

{% block title %}Data Quality - Dataset State Historian{% endblock %}

{% block extra_css %}
<style>
.quality-container {
    padding: var(--space-6);
    max-width: 1400px;
    margin: 0 auto;
}

.quality-header {
    margin-bottom: var(--space-8);
}

.quality-title {
    font-size: var(--text-4xl);
    font-weight: var(--font-bold);
    color: var(--gray-900);
    margin-bottom: var(--space-2);
}

.quality-subtitle {
    font-size: var(--text-lg);
    color: var(--gray-600);
    margin-bottom: var(--space-6);
}


.quality-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: var(--space-6);
    margin-bottom: var(--space-8);
}

.quality-section {
    background: white;
    border: 1px solid var(--gray-200);
    padding: var(--space-6);
}

.section-title {
    font-size: var(--text-xl);
    font-weight: var(--font-semibold);
    color: var(--gray-900);
    margin-bottom: var(--space-4);
    padding-bottom: var(--space-2);
    border-bottom: 1px solid var(--gray-200);
}

.metric-list {
    display: flex;
    flex-direction: column;
    gap: var(--space-3);
}

.metric-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-3);
    background: var(--gray-50);
    border: 1px solid var(--gray-200);
}

.metric-name {
    font-weight: var(--font-medium);
    color: var(--gray-900);
}

.metric-value {
    font-family: var(--font-mono);
    font-size: var(--text-sm);
    color: var(--gray-700);
}

.metric-status {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    margin-left: var(--space-2);
}

.metric-status.excellent {
    background: var(--success);
}

.metric-status.good {
    background: var(--info);
}

.metric-status.fair {
    background: var(--warning);
}

.metric-status.poor {
    background: var(--error);
}

.issues-list {
    display: flex;
    flex-direction: column;
    gap: var(--space-3);
}

.issue-item {
    padding: var(--space-4);
    border: 1px solid var(--gray-200);
    border-radius: 0;
    transition: all var(--transition-fast);
}

.issue-item:hover {
    border-color: var(--primary);
    box-shadow: var(--shadow-sm);
}

.issue-item.high {
    border-left: 4px solid var(--error);
}

.issue-item.medium {
    border-left: 4px solid var(--warning);
}

.issue-item.low {
    border-left: 4px solid var(--info);
}

.issue-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-2);
}

.issue-title {
    font-weight: var(--font-semibold);
    color: var(--gray-900);
}

.issue-severity {
    padding: var(--space-1) var(--space-2);
    border-radius: 0;
    font-size: var(--text-xs);
    font-weight: var(--font-medium);
    text-transform: uppercase;
}

.issue-severity.high {
    background: var(--error);
    color: white;
}

.issue-severity.medium {
    background: var(--warning);
    color: white;
}

.issue-severity.low {
    background: var(--info);
    color: white;
}

.issue-details {
    color: var(--gray-600);
    font-size: var(--text-sm);
    margin-bottom: var(--space-2);
}

.issue-tags {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-1);
}

.issue-tag {
    padding: var(--space-1) var(--space-2);
    background: var(--gray-100);
    color: var(--gray-700);
    border-radius: 0;
    font-size: var(--text-xs);
}

.recommendations-list {
    display: flex;
    flex-direction: column;
    gap: var(--space-4);
}

.recommendation-item {
    padding: var(--space-4);
    background: var(--gray-50);
    border: 1px solid var(--gray-200);
    border-radius: 0;
}

.recommendation-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-2);
}

.recommendation-category {
    font-weight: var(--font-semibold);
    color: var(--gray-900);
}

.recommendation-priority {
    padding: var(--space-1) var(--space-2);
    border-radius: 0;
    font-size: var(--text-xs);
    font-weight: var(--font-medium);
    text-transform: uppercase;
}

.recommendation-priority.high {
    background: var(--error);
    color: white;
}

.recommendation-priority.medium {
    background: var(--warning);
    color: white;
}

.recommendation-priority.low {
    background: var(--info);
    color: white;
}

.recommendation-description {
    color: var(--gray-700);
    margin-bottom: var(--space-2);
}

.recommendation-action {
    color: var(--gray-600);
    font-size: var(--text-sm);
    margin-bottom: var(--space-1);
}

.recommendation-impact {
    color: var(--gray-500);
    font-size: var(--text-xs);
    font-style: italic;
}

.refresh-button {
    padding: var(--space-2) var(--space-4);
    background: var(--primary);
    color: white;
    border: none;
    border-radius: 0;
    cursor: pointer;
    font-size: var(--text-sm);
    font-weight: var(--font-medium);
    transition: all var(--transition-fast);
    margin-bottom: var(--space-4);
}

.refresh-button:hover {
    background: var(--primary-dark);
}

.loading {
    text-align: center;
    padding: var(--space-8);
    color: var(--gray-500);
}

.error {
    background: var(--gray-100);
    color: var(--gray-700);
    padding: var(--space-4);
    border: 1px solid var(--gray-300);
    margin: var(--space-4) 0;
    border-radius: 0;
}

.export-section {
    background: white;
    border: 1px solid var(--gray-200);
    padding: var(--space-6);
    margin-bottom: var(--space-8);
}

.export-buttons {
    display: flex;
    gap: var(--space-4);
    flex-wrap: wrap;
}

.export-button {
    padding: var(--space-3) var(--space-6);
    background: var(--primary);
    color: white;
    border: none;
    border-radius: 0;
    cursor: pointer;
    font-weight: var(--font-medium);
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: var(--space-2);
    transition: all var(--transition-fast);
}

.export-button:hover {
    background: var(--primary-dark);
    color: white;
    text-decoration: none;
}

.export-button.secondary {
    background: var(--gray-100);
    color: var(--gray-700);
    border: 1px solid var(--gray-300);
}

.export-button.secondary:hover {
    background: var(--gray-200);
    color: var(--gray-900);
}

.quality-description {
    color: var(--gray-600);
    margin-bottom: var(--space-4);
}
</style>
{% endblock %}

{% block content %}
<div class="quality-container">
    <div class="quality-header">
        <h1 class="quality-title">Data Quality Assessment</h1>
        <p class="quality-subtitle">Comprehensive data quality analysis and improvement recommendations</p>
    </div>

    <!-- Refresh Button -->
    <button class="refresh-button" onclick="refreshQualityData()">
        REFRESH Refresh Quality Data
    </button>


    <!-- Quality Metrics and Issues -->
    <div class="quality-grid">
        <!-- Quality Metrics -->
        <div class="quality-section">
            <h2 class="section-title">Quality Metrics by Agency</h2>
            <div class="metric-list" id="agency-metrics">
                <div class="loading">Loading agency metrics...</div>
            </div>
        </div>

        <!-- Quality Issues -->
        <div class="quality-section">
            <h2 class="section-title">Quality Issues</h2>
            <div class="issues-list" id="quality-issues">
                <div class="loading">Loading quality issues...</div>
            </div>
        </div>
    </div>

    <!-- Recommendations -->
    <div class="quality-section">
        <h2 class="section-title">Improvement Recommendations</h2>
        <div class="recommendations-list" id="recommendations">
            <div class="loading">Loading recommendations...</div>
        </div>
    </div>

    <!-- Export Section -->
    <div class="export-section">
        <h2 class="section-title">Export Quality Report</h2>
        <p class="quality-description">
            Export comprehensive data quality reports for further analysis
        </p>
        <div class="export-buttons">
            <button class="export-button" onclick="exportQualityReport('csv')">
                ANALYTICS Export CSV
            </button>
            <button class="export-button" onclick="exportQualityReport('json')">
                FILE Export JSON
            </button>
            <button class="export-button secondary" onclick="exportQualityReport('pdf')">
                LIST Export PDF
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Load quality data
function loadQualityData() {
    loadQualityMetrics();
    loadQualityIssues();
    loadRecommendations();
}


// Load quality metrics
function loadQualityMetrics() {
    fetch('/api/quality/metrics')
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                console.error('Error loading quality metrics:', data.error);
                return;
            }
            
            const container = document.getElementById('agency-metrics');
            if (data.agency_metrics && data.agency_metrics.length > 0) {
                container.innerHTML = data.agency_metrics.slice(0, 10).map(agency => `
                    <div class="metric-item">
                        <span class="metric-name">${escapeHtml(agency.agency)}</span>
                        <span class="metric-value">${agency.availability_rate}%</span>
                        <div class="metric-status ${getQualityStatus(agency.availability_rate)}"></div>
                    </div>
                `).join('');
            } else {
                container.innerHTML = '<div class="loading">No agency metrics available</div>';
            }
        })
        .catch(error => {
            console.error('Error loading quality metrics:', error);
            document.getElementById('agency-metrics').innerHTML = '<div class="error">Error loading metrics</div>';
        });
}

// Load quality issues
function loadQualityIssues() {
    fetch('/api/quality/issues')
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                console.error('Error loading quality issues:', data.error);
                return;
            }
            
            const container = document.getElementById('quality-issues');
            if (data.quality_issues && data.quality_issues.length > 0) {
                container.innerHTML = data.quality_issues.slice(0, 10).map(issue => `
                    <div class="issue-item ${issue.severity}">
                        <div class="issue-header">
                            <span class="issue-title">${escapeHtml(issue.title)}</span>
                            <span class="issue-severity ${issue.severity}">${issue.severity}</span>
                        </div>
                        <div class="issue-details">${escapeHtml(issue.agency)}</div>
                        <div class="issue-tags">
                            ${issue.issues.map(issue_tag => `
                                <span class="issue-tag">${escapeHtml(issue_tag)}</span>
                            `).join('')}
                        </div>
                    </div>
                `).join('');
            } else {
                container.innerHTML = '<div class="loading">No quality issues found</div>';
            }
        })
        .catch(error => {
            console.error('Error loading quality issues:', error);
            document.getElementById('quality-issues').innerHTML = '<div class="error">Error loading issues</div>';
        });
}

// Load recommendations
function loadRecommendations() {
    fetch('/api/quality/recommendations')
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                console.error('Error loading recommendations:', data.error);
                return;
            }
            
            const container = document.getElementById('recommendations');
            if (data.recommendations && data.recommendations.length > 0) {
                container.innerHTML = data.recommendations.map(rec => `
                    <div class="recommendation-item">
                        <div class="recommendation-header">
                            <span class="recommendation-category">${escapeHtml(rec.category)}</span>
                            <span class="recommendation-priority ${rec.priority}">${rec.priority}</span>
                        </div>
                        <div class="recommendation-description">${escapeHtml(rec.description)}</div>
                        <div class="recommendation-action"><strong>Action:</strong> ${escapeHtml(rec.action)}</div>
                        <div class="recommendation-impact"><strong>Impact:</strong> ${escapeHtml(rec.impact)}</div>
                    </div>
                `).join('');
            } else {
                container.innerHTML = '<div class="loading">No recommendations available</div>';
            }
        })
        .catch(error => {
            console.error('Error loading recommendations:', error);
            document.getElementById('recommendations').innerHTML = '<div class="error">Error loading recommendations</div>';
        });
}

// Get quality status based on score
function getQualityStatus(score) {
    if (score >= 90) return 'excellent';
    if (score >= 80) return 'good';
    if (score >= 70) return 'fair';
    return 'poor';
}

// Refresh quality data
function refreshQualityData() {
    // Show loading state
    document.getElementById('quality-overview').innerHTML = `
        <div class="quality-card">
            <div class="quality-icon">PROCESSING</div>
            <div class="quality-value">Loading...</div>
            <div class="quality-label">Refreshing Data</div>
        </div>
    `;
    
    loadQualityData();
}

// Export quality report
function exportQualityReport(format) {
    const url = `/api/quality/export?format=${format}`;
    
    // Create download link
    const link = document.createElement('a');
    link.href = url;
    link.download = `quality_report.${format}`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

// Escape HTML
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    loadQualityData();
    
    // Auto-refresh every 5 minutes
    setInterval(loadQualityData, 300000);
});
</script>
{% endblock %}

