{% extends "layouts/layout.html" %}

{% block title %}Analytics - Dataset State Historian{% endblock %}

{% block extra_css %}
<style>
.analytics-container {
    padding: var(--space-6);
    max-width: 1400px;
    margin: 0 auto;
}

.analytics-header {
    margin-bottom: var(--space-8);
}

.analytics-title {
    font-size: var(--text-4xl);
    font-weight: var(--font-bold);
    color: var(--gray-900);
    margin-bottom: var(--space-2);
}

.analytics-subtitle {
    font-size: var(--text-lg);
    color: var(--gray-600);
    margin-bottom: var(--space-6);
}

.metrics-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: var(--space-6);
    margin-bottom: var(--space-8);
}

.metric-card {
    background: white;
    border: 1px solid var(--gray-200);
    padding: var(--space-6);
    text-align: center;
    transition: all var(--transition-fast);
}

.metric-card:hover {
    border-color: var(--primary);
    box-shadow: var(--shadow-md);
}

.metric-value {
    font-size: var(--text-3xl);
    font-weight: var(--font-bold);
    color: var(--primary);
    margin-bottom: var(--space-2);
}

.metric-label {
    font-size: var(--text-sm);
    color: var(--gray-600);
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.metric-change {
    font-size: var(--text-xs);
    margin-top: var(--space-2);
    padding: var(--space-1) var(--space-2);
    border-radius: 0;
    display: inline-block;
}

.metric-change.positive {
    background: var(--success-light);
    color: var(--success-dark);
}

.metric-change.negative {
    background: var(--error-light);
    color: var(--error-dark);
}

.metric-change.neutral {
    background: var(--gray-100);
    color: var(--gray-700);
}

.charts-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
    gap: var(--space-6);
    margin-bottom: var(--space-8);
}

.chart-container {
    background: white;
    border: 1px solid var(--gray-200);
    padding: var(--space-6);
}

.chart-title {
    font-size: var(--text-xl);
    font-weight: var(--font-semibold);
    color: var(--gray-900);
    margin-bottom: var(--space-4);
    padding-bottom: var(--space-2);
    border-bottom: 1px solid var(--gray-200);
}

.chart-content {
    min-height: 300px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.agency-list {
    background: white;
    border: 1px solid var(--gray-200);
    padding: var(--space-6);
    margin-bottom: var(--space-8);
}

.agency-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-4);
    border-bottom: 1px solid var(--gray-100);
    transition: all var(--transition-fast);
}

.agency-item:hover {
    background: var(--gray-50);
}

.agency-item:last-child {
    border-bottom: none;
}

.agency-name {
    font-weight: var(--font-semibold);
    color: var(--gray-900);
}

.agency-stats {
    display: flex;
    gap: var(--space-4);
    font-size: var(--text-sm);
    color: var(--gray-600);
}

.agency-stat {
    text-align: center;
}

.agency-stat-value {
    font-weight: var(--font-semibold);
    color: var(--primary);
}

.agency-stat-label {
    font-size: var(--text-xs);
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.diff-summary {
    background: white;
    border: 1px solid var(--gray-200);
    padding: var(--space-6);
    margin-bottom: var(--space-8);
}

.diff-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-3);
    border-bottom: 1px solid var(--gray-100);
}

.diff-item:last-child {
    border-bottom: none;
}

.diff-dataset {
    font-weight: var(--font-medium);
    color: var(--gray-900);
}

.diff-changes {
    font-size: var(--text-sm);
    color: var(--gray-600);
}

.diff-type {
    padding: var(--space-1) var(--space-2);
    border-radius: 0;
    font-size: var(--text-xs);
    font-weight: var(--font-medium);
    text-transform: uppercase;
}

.diff-type.content {
    background: var(--info-light);
    color: var(--info-dark);
}

.diff-type.schema {
    background: var(--warning-light);
    color: var(--warning-dark);
}

.diff-type.metadata {
    background: var(--success-light);
    color: var(--success-dark);
}

.diff-type.availability {
    background: var(--error-light);
    color: var(--error-dark);
}

.loading {
    text-align: center;
    padding: var(--space-8);
    color: var(--gray-500);
}

.error {
    background: var(--gray-100);
    color: var(--gray-700);
    padding: var(--space-4);
    border: 1px solid var(--gray-300);
    margin: var(--space-4) 0;
    border-radius: 0;
}

.refresh-button {
    padding: var(--space-2) var(--space-4);
    background: var(--primary);
    color: white;
    border: none;
    border-radius: 0;
    cursor: pointer;
    font-size: var(--text-sm);
    font-weight: var(--font-medium);
    transition: all var(--transition-fast);
    margin-bottom: var(--space-4);
}

.refresh-button:hover {
    background: var(--primary-dark);
}

.export-buttons {
    display: flex;
    gap: var(--space-3);
    margin-bottom: var(--space-6);
}

.export-button {
    padding: var(--space-2) var(--space-4);
    background: var(--gray-100);
    color: var(--gray-700);
    border: 1px solid var(--gray-300);
    border-radius: 0;
    cursor: pointer;
    font-size: var(--text-sm);
    font-weight: var(--font-medium);
    text-decoration: none;
    transition: all var(--transition-fast);
}

.export-button:hover {
    background: var(--gray-200);
    color: var(--gray-900);
    text-decoration: none;
}

.export-button.primary {
    background: var(--primary);
    color: white;
    border-color: var(--primary);
}

.export-button.primary:hover {
    background: var(--primary-dark);
    color: white;
}
</style>
{% endblock %}

{% block content %}
<div class="analytics-container">
    <div class="analytics-header">
        <h1 class="analytics-title">Dataset Analytics</h1>
        <p class="analytics-subtitle">Comprehensive analysis of dataset changes and agency distribution</p>
    </div>

    <!-- Refresh and Export Controls -->
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-6);">
        <button class="refresh-button" onclick="refreshAnalytics()">
            REFRESH
        </button>
        <div class="export-buttons">
            <button class="export-button primary" onclick="exportData('csv')">
                EXPORT CSV
            </button>
            <button class="export-button" onclick="exportData('json')">
                EXPORT JSON
            </button>
            <button class="export-button" onclick="exportData('pdf')">
                EXPORT PDF
            </button>
        </div>
    </div>

    <!-- Key Metrics -->
    <div class="metrics-grid" id="metrics-grid">
        <div class="metric-card">
            <div class="metric-value" id="total-datasets">-</div>
            <div class="metric-label">Total Datasets</div>
            <div class="metric-change neutral" id="datasets-change">Loading...</div>
        </div>
        <div class="metric-card">
            <div class="metric-value" id="total-changes">-</div>
            <div class="metric-label">Total Changes</div>
            <div class="metric-change neutral" id="changes-change">Loading...</div>
        </div>
        <div class="metric-card">
            <div class="metric-value" id="active-agencies">-</div>
            <div class="metric-label">Active Agencies</div>
            <div class="metric-change neutral" id="agencies-change">Loading...</div>
        </div>
        <div class="metric-card">
            <div class="metric-value" id="avg-quality">-</div>
            <div class="metric-label">Avg Quality Score</div>
            <div class="metric-change neutral" id="quality-change">Loading...</div>
        </div>
        <div class="metric-card">
            <div class="metric-value" id="recent-changes">-</div>
            <div class="metric-label">Changes Today</div>
            <div class="metric-change neutral" id="recent-change">Loading...</div>
        </div>
        <div class="metric-card">
            <div class="metric-value" id="data-volume">-</div>
            <div class="metric-label">Total Data Volume</div>
            <div class="metric-change neutral" id="volume-change">Loading...</div>
        </div>
    </div>

    <!-- Charts Grid -->
    <div class="charts-grid">
        <div class="chart-container">
            <h3 class="chart-title">Dataset Changes Over Time</h3>
            <div class="chart-content" id="changes-chart">
                <div class="loading">Loading changes chart...</div>
            </div>
        </div>
        <div class="chart-container">
            <h3 class="chart-title">Agency Distribution</h3>
            <div class="chart-content" id="agency-chart">
                <div class="loading">Loading agency chart...</div>
            </div>
        </div>
        <div class="chart-container">
            <h3 class="chart-title">Data Quality Trends</h3>
            <div class="chart-content" id="quality-chart">
                <div class="loading">Loading quality chart...</div>
            </div>
        </div>
        <div class="chart-container">
            <h3 class="chart-title">Format Distribution</h3>
            <div class="chart-content" id="format-chart">
                <div class="loading">Loading format chart...</div>
            </div>
        </div>
    </div>

    <!-- Agency Performance -->
    <div class="agency-list">
        <h3 class="chart-title">Agency Performance</h3>
        <div id="agency-list">
            <div class="loading">Loading agency data...</div>
        </div>
    </div>

    <!-- Recent Changes -->
    <div class="diff-summary">
        <h3 class="chart-title">Recent Dataset Changes</h3>
        <div id="recent-changes-list">
            <div class="loading">Loading recent changes...</div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Load analytics data
function loadAnalyticsData() {
    loadMetrics();
    loadCharts();
    loadAgencyData();
    loadRecentChanges();
}

// Load key metrics
function loadMetrics() {
    fetch('/api/stats')
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                console.error('Error loading metrics:', data.error);
                return;
            }
            
            // Update metrics
            document.getElementById('total-datasets').textContent = data.total_datasets?.toLocaleString() || '0';
            document.getElementById('total-changes').textContent = data.total_changes?.toLocaleString() || '0';
            document.getElementById('active-agencies').textContent = data.unique_agencies?.toLocaleString() || '0';
            document.getElementById('avg-quality').textContent = data.avg_quality_score || 'N/A';
            document.getElementById('recent-changes').textContent = data.recent_changes?.toLocaleString() || '0';
            document.getElementById('data-volume').textContent = formatBytes(data.total_data_volume || 0);
            
            // Update change indicators
            updateChangeIndicator('datasets-change', data.datasets_change);
            updateChangeIndicator('changes-change', data.changes_change);
            updateChangeIndicator('agencies-change', data.agencies_change);
            updateChangeIndicator('quality-change', data.quality_change);
            updateChangeIndicator('recent-change', data.recent_change);
            updateChangeIndicator('volume-change', data.volume_change);
        })
        .catch(error => {
            console.error('Error loading metrics:', error);
            showError('Error loading metrics');
        });
}

// Load charts
function loadCharts() {
    loadChangesChart();
    loadAgencyChart();
    loadQualityChart();
    loadFormatChart();
}

// Load changes chart
function loadChangesChart() {
    fetch('/api/analytics/trends?period=30')
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                console.error('Error loading changes chart:', data.error);
                return;
            }
            
            const chartElement = document.getElementById('changes-chart');
            chartElement.innerHTML = '<div style="color: var(--gray-500);">Changes chart would be displayed here</div>';
        })
        .catch(error => {
            console.error('Error loading changes chart:', error);
            document.getElementById('changes-chart').innerHTML = '<div class="error">Error loading changes chart</div>';
        });
}

// Load agency chart
function loadAgencyChart() {
    fetch('/api/analytics/agencies')
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                console.error('Error loading agency chart:', data.error);
                return;
            }
            
            const chartElement = document.getElementById('agency-chart');
            chartElement.innerHTML = '<div style="color: var(--gray-500);">Agency distribution chart would be displayed here</div>';
        })
        .catch(error => {
            console.error('Error loading agency chart:', error);
            document.getElementById('agency-chart').innerHTML = '<div class="error">Error loading agency chart</div>';
        });
}

// Load quality chart
function loadQualityChart() {
    fetch('/api/analytics/quality')
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                console.error('Error loading quality chart:', data.error);
                return;
            }
            
            const chartElement = document.getElementById('quality-chart');
            chartElement.innerHTML = '<div style="color: var(--gray-500);">Quality trends chart would be displayed here</div>';
        })
        .catch(error => {
            console.error('Error loading quality chart:', error);
            document.getElementById('quality-chart').innerHTML = '<div class="error">Error loading quality chart</div>';
        });
}

// Load format chart
function loadFormatChart() {
    fetch('/api/analytics/formats')
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                console.error('Error loading format chart:', data.error);
                return;
            }
            
            const chartElement = document.getElementById('format-chart');
            chartElement.innerHTML = '<div style="color: var(--gray-500);">Format distribution chart would be displayed here</div>';
        })
        .catch(error => {
            console.error('Error loading format chart:', error);
            document.getElementById('format-chart').innerHTML = '<div class="error">Error loading format chart</div>';
        });
}

// Load agency data
function loadAgencyData() {
    fetch('/api/agencies?limit=20')
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                console.error('Error loading agency data:', data.error);
                return;
            }
            
            const container = document.getElementById('agency-list');
            if (data.agencies && data.agencies.length > 0) {
                container.innerHTML = data.agencies.map(agency => `
                    <div class="agency-item">
                        <div class="agency-name">${escapeHtml(agency.agency)}</div>
                        <div class="agency-stats">
                            <div class="agency-stat">
                                <div class="agency-stat-value">${agency.dataset_count || 0}</div>
                                <div class="agency-stat-label">Datasets</div>
                            </div>
                            <div class="agency-stat">
                                <div class="agency-stat-value">${agency.avg_quality_score || 'N/A'}</div>
                                <div class="agency-stat-label">Quality</div>
                            </div>
                            <div class="agency-stat">
                                <div class="agency-stat-value">${agency.last_update || 'N/A'}</div>
                                <div class="agency-stat-label">Last Update</div>
                            </div>
                        </div>
                    </div>
                `).join('');
            } else {
                container.innerHTML = '<div class="loading">No agency data available</div>';
            }
        })
        .catch(error => {
            console.error('Error loading agency data:', error);
            document.getElementById('agency-list').innerHTML = '<div class="error">Error loading agency data</div>';
        });
}

// Load recent changes
function loadRecentChanges() {
    fetch('/api/wayback/changes/recent?limit=10')
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                console.error('Error loading recent changes:', data.error);
                return;
            }
            
            const container = document.getElementById('recent-changes-list');
            if (data.changes && data.changes.length > 0) {
                container.innerHTML = data.changes.map(change => `
                    <div class="diff-item">
                        <div class="diff-dataset">${escapeHtml(change.dataset_title || 'Unknown Dataset')}</div>
                        <div class="diff-changes">${change.change_description || 'No description'}</div>
                        <div class="diff-type ${change.change_type || 'content'}">${change.change_type || 'content'}</div>
                    </div>
                `).join('');
            } else {
                container.innerHTML = '<div class="loading">No recent changes available</div>';
            }
        })
        .catch(error => {
            console.error('Error loading recent changes:', error);
            document.getElementById('recent-changes-list').innerHTML = '<div class="error">Error loading recent changes</div>';
        });
}

// Update change indicator
function updateChangeIndicator(elementId, change) {
    const element = document.getElementById(elementId);
    if (!element || !change) return;
    
    const value = Math.abs(change);
    const isPositive = change > 0;
    const isNegative = change < 0;
    
    element.textContent = `${isPositive ? '+' : ''}${change}%`;
    element.className = `metric-change ${isPositive ? 'positive' : isNegative ? 'negative' : 'neutral'}`;
}

// Format bytes
function formatBytes(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// Export data
function exportData(format) {
    const url = `/api/export/analytics?format=${format}`;
    window.open(url, '_blank');
}

// Refresh analytics
function refreshAnalytics() {
    loadAnalyticsData();
}

// Show error
function showError(message) {
    const container = document.getElementById('metrics-grid');
    container.innerHTML = `<div class="error">${message}</div>`;
}

// Escape HTML
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Initialize analytics
document.addEventListener('DOMContentLoaded', function() {
    loadAnalyticsData();
    
    // Auto-refresh every 5 minutes
    setInterval(loadAnalyticsData, 300000);
});
</script>
{% endblock %}
